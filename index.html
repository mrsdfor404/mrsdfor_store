<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MR Store - TOP-UP</title>
<style>
:root {
  --bg: #0b0f1a;
  --card: #111726;
  --accent: #4da3ff;
  --gold: #ffd700;
  --note: #ffcc00;
  --muted: #99a3b3;
  --success: #00d4aa;
  --error: #ff4444;
  --warning: #ff9800;
  --paypal: #0070ba;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Tajawal", sans-serif;
  background: var(--bg);
  color: #fff;
  line-height: 1.6;
  min-height: 100vh;
}

/* Header */
header {
  background: var(--card);
  padding: 18px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid var(--accent);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 24px;
  font-weight: 900;
  color: var(--accent);
  text-decoration: none;
}

.logo i {
  font-size: 28px;
}

.user-section {
  display: flex;
  align-items: center;
  gap: 15px;
}

#authBtn, #userMenuBtn {
  background: linear-gradient(135deg, #0ff3d0, #00b2ff);
  color: #051020;
  border: none;
  padding: 10px 18px;
  border-radius: 10px;
  font-weight: 800;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
}

#authBtn:hover, #userMenuBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 178, 255, 0.4);
}

#userMenu {
  display: none;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ffd700, #ffb84d);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  color: #000;
  cursor: pointer;
  overflow: hidden;
  border: 2px solid var(--accent);
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.user-dropdown {
  display: none;
  position: absolute;
  top: 70px;
  right: 20px;
  background: var(--card);
  border: 2px solid var(--accent);
  border-radius: 10px;
  padding: 10px;
  min-width: 200px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  z-index: 1001;
}

.user-dropdown button {
  width: 100%;
  padding: 10px;
  background: transparent;
  border: none;
  color: #fff;
  text-align: right;
  cursor: pointer;
  border-radius: 6px;
  margin: 2px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
}

.user-dropdown button:hover {
  background: rgba(77, 163, 255, 0.1);
}

/* Navigation */
.main-nav {
  background: #131a2c;
  display: flex;
  justify-content: center;
  gap: 5px;
  padding: 10px;
  position: sticky;
  top: 76px;
  z-index: 999;
  flex-wrap: wrap;
}

.nav-btn {
  color: var(--accent);
  text-decoration: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  transition: all 0.3s;
  border: none;
  background: transparent;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 15px;
}

.nav-btn:hover {
  background: #0f1724;
  transform: translateY(-2px);
}

.nav-btn.active {
  background: var(--accent);
  color: #081220;
  box-shadow: 0 4px 12px rgba(77, 163, 255, 0.3);
}

/* Main Container */
.main-container {
  max-width: 1000px;
  margin: 25px auto;
  padding: 0 20px;
}

.section {
  display: none;
  animation: fadeIn 0.5s ease;
}

.section.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Card Styles */
.section-card {
  background: var(--card);
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 25px;
  border: 2px solid rgba(77, 163, 255, 0.3);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.section-title {
  color: var(--gold);
  font-size: 26px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid rgba(255, 215, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 12px;
}

/* Tax Warning */
.tax-warning {
  background: rgba(255, 152, 0, 0.1);
  border: 2px solid var(--warning);
  border-radius: 10px;
  padding: 15px;
  margin: 15px 0;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.tax-warning i {
  color: var(--warning);
  font-size: 20px;
  margin-top: 2px;
}

.tax-warning p {
  color: var(--warning);
  font-weight: 700;
  margin: 0;
}

/* PayPal Section */
.paypal-section {
  background: linear-gradient(135deg, rgba(0, 112, 186, 0.1), rgba(0, 112, 186, 0.05));
  border: 2px solid var(--paypal);
  border-radius: 15px;
  padding: 25px;
  margin: 25px 0;
  text-align: center;
}

.paypal-title {
  color: var(--paypal);
  font-size: 24px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.paypal-qr {
  max-width: 250px;
  margin: 20px auto;
  background: white;
  padding: 15px;
  border-radius: 10px;
  border: 3px solid var(--paypal);
}

.paypal-qr img {
  width: 100%;
  height: auto;
  border-radius: 5px;
}

.paypal-link {
  display: inline-block;
  background: var(--paypal);
  color: white;
  padding: 12px 25px;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 900;
  margin-top: 15px;
  transition: all 0.3s;
}

.paypal-link:hover {
  background: #005ea6;
  transform: translateY(-2px);
}

/* ========== المنتجات ========== */
.category-selector {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
}

.category-card {
  background: linear-gradient(135deg, rgba(15, 23, 36, 0.8), rgba(77, 163, 255, 0.1));
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid transparent;
}

.category-card:hover {
  transform: translateY(-5px);
  border-color: var(--accent);
  box-shadow: 0 10px 25px rgba(77, 163, 255, 0.2);
}

.category-card.active {
  background: linear-gradient(135deg, var(--accent), #0077cc);
  border-color: var(--accent);
}

.category-icon {
  font-size: 40px;
  margin-bottom: 15px;
  color: var(--accent);
}

.category-card.active .category-icon {
  color: white;
}

.category-name {
  font-size: 18px;
  font-weight: 900;
  margin-bottom: 8px;
}

.category-desc {
  font-size: 14px;
  color: var(--muted);
}

/* TOP UP Section */
.topup-options {
  display: none;
}

.topup-options.active {
  display: block;
}

.game-select {
  width: 100%;
  padding: 12px;
  background: rgba(0, 0, 0, 0.3);
  border: 2px solid var(--accent);
  border-radius: 10px;
  color: white;
  font-size: 16px;
  margin-bottom: 20px;
}

.packages-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.package-card {
  background: rgba(15, 23, 36, 0.7);
  border-radius: 10px;
  padding: 15px;
  border: 2px solid rgba(77, 163, 255, 0.3);
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.package-card:hover {
  border-color: var(--accent);
  transform: translateY(-3px);
}

.package-card.selected {
  background: rgba(0, 212, 170, 0.1);
  border-color: var(--success);
  box-shadow: 0 5px 15px rgba(0, 212, 170, 0.2);
}

.package-name {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--accent);
}

.package-price {
  color: var(--gold);
  font-weight: 900;
  font-size: 18px;
}

.package-desc {
  font-size: 13px;
  color: var(--muted);
  margin-top: 5px;
}

/* Discount Button */
.discount-btn {
  background: linear-gradient(135deg, var(--success), #00b894);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 900;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 15px 0;
  width: 100%;
  justify-content: center;
  transition: all 0.3s;
}

.discount-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 212, 170, 0.3);
}

.discount-btn.used {
  background: #666;
  cursor: not-allowed;
  opacity: 0.7;
}

/* Order Summary */
.order-summary-box {
  background: rgba(0, 212, 170, 0.1);
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
  border: 2px solid rgba(0, 212, 170, 0.3);
}

.summary-title {
  color: var(--success);
  font-size: 18px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.selected-packages {
  list-style: none;
  margin: 0;
  padding: 0;
  max-height: 200px;
  overflow-y: auto;
}

.selected-packages li {
  padding: 10px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 6px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.total-price {
  color: var(--gold);
  font-weight: 900;
  font-size: 24px;
  text-align: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 2px solid rgba(255, 215, 0, 0.3);
}

/* Customer Info */
.customer-info {
  background: rgba(77, 163, 255, 0.1);
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
  border: 2px solid rgba(77, 163, 255, 0.3);
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 700;
  color: var(--accent);
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 12px;
  background: rgba(0, 0, 0, 0.3);
  border: 2px solid rgba(77, 163, 255, 0.3);
  border-radius: 8px;
  color: white;
  font-size: 16px;
  transition: all 0.3s;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 15px rgba(77, 163, 255, 0.3);
}

.form-group textarea {
  min-height: 100px;
  resize: vertical;
}

/* Action Buttons */
.action-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 25px;
}

.btn {
  padding: 15px;
  border: none;
  border-radius: 10px;
  font-weight: 900;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: all 0.3s;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), #0077cc);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(77, 163, 255, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, var(--success), #00b894);
  color: white;
}

.btn-success:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 212, 170, 0.4);
}

.btn-warning {
  background: linear-gradient(135deg, var(--gold), #ffcc00);
  color: #000;
}

.btn-warning:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, var(--error), #d63031);
  color: white;
}

.btn-danger:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(255, 68, 68, 0.4);
}

/* ========== بطاقات الانترنت ========== */
.internet-options {
  display: none;
}

.internet-options.active {
  display: block;
}

.operator-buttons {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.operator-btn {
  background: rgba(15, 23, 36, 0.7);
  border: 2px solid rgba(77, 163, 255, 0.3);
  padding: 15px 25px;
  border-radius: 10px;
  color: var(--accent);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.operator-btn:hover {
  transform: translateY(-3px);
  border-color: var(--accent);
}

.operator-btn.active {
  background: linear-gradient(135deg, var(--accent), #0077cc);
  color: white;
  border-color: var(--accent);
}

.type-selector {
  display: flex;
  gap: 10px;
  margin: 20px 0;
  justify-content: center;
}

.type-btn {
  background: rgba(15, 23, 36, 0.7);
  border: 2px solid rgba(77, 163, 255, 0.3);
  padding: 10px 20px;
  border-radius: 8px;
  color: var(--accent);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}

.type-btn:hover {
  border-color: var(--accent);
}

.type-btn.active {
  background: linear-gradient(135deg, #ff4444, #d63031);
  color: white;
  border-color: #ff4444;
}

.type-btn.active.internet {
  background: linear-gradient(135deg, #00d4aa, #00b894);
  border-color: #00d4aa;
}

/* ========== البطاقات ========== */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.card-item {
  background: rgba(15, 23, 36, 0.8);
  border-radius: 12px;
  padding: 20px;
  border: 2px solid rgba(77, 163, 255, 0.3);
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.card-item:hover {
  border-color: var(--accent);
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.card-item.selected {
  background: rgba(0, 212, 170, 0.1);
  border-color: var(--success);
  box-shadow: 0 0 20px rgba(0, 212, 170, 0.2);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.card-title {
  font-size: 18px;
  font-weight: 900;
  margin: 0;
}

.card-price {
  color: var(--gold);
  font-weight: 900;
  font-size: 20px;
}

.card-description {
  color: var(--muted);
  font-size: 14px;
  margin-bottom: 15px;
  line-height: 1.5;
}

.card-features {
  list-style: none;
  padding: 0;
  margin: 0;
}

.card-features li {
  padding: 5px 0;
  color: #ddd;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-features li:before {
  content: "✓";
  color: var(--success);
  font-weight: bold;
}

/* ========== طرق الدفع ========== */
.payment-methods {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin: 25px 0;
}

.payment-method {
  background: rgba(15, 23, 36, 0.7);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  border: 2px solid rgba(77, 163, 255, 0.3);
  transition: all 0.3s;
}

.payment-method:hover {
  transform: translateY(-5px);
  border-color: var(--accent);
}

.payment-icon {
  font-size: 40px;
  margin-bottom: 15px;
  color: var(--accent);
}

.payment-name {
  font-size: 18px;
  font-weight: 900;
  margin-bottom: 10px;
  color: var(--gold);
}

.payment-desc {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 15px;
}

.copy-btn {
  background: rgba(77, 163, 255, 0.2);
  color: var(--accent);
  border: 1px solid var(--accent);
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 700;
  transition: all 0.3s;
}

.copy-btn:hover {
  background: var(--accent);
  color: #051020;
}

/* Notes */
.note-box {
  background: rgba(255, 204, 0, 0.1);
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
  border-left: 4px solid var(--note);
}

.note-box.important {
  background: rgba(255, 68, 68, 0.1);
  border-left-color: var(--error);
}

.note-title {
  color: var(--note);
  font-weight: 900;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 18px;
}

.note-title.important {
  color: var(--error);
}

/* ========== الملف الشخصي ========== */
.profile-header {
  text-align: center;
  margin-bottom: 30px;
}

.profile-avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ffd700, #ffb84d);
  margin: 0 auto 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  font-weight: 900;
  color: #000;
  border: 4px solid var(--accent);
  overflow: hidden;
}

.profile-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-name {
  font-size: 24px;
  font-weight: 900;
  color: var(--accent);
  margin-bottom: 5px;
}

.profile-email {
  color: var(--muted);
  font-size: 16px;
}

.profile-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin: 25px 0;
}

.stat-card {
  background: rgba(15, 23, 36, 0.7);
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  border: 2px solid rgba(77, 163, 255, 0.3);
}

.stat-value {
  font-size: 32px;
  font-weight: 900;
  color: var(--gold);
  margin-bottom: 5px;
}

.stat-label {
  color: var(--muted);
  font-size: 14px;
}

.order-history {
  max-height: 400px;
  overflow-y: auto;
  margin-top: 20px;
}

.order-card {
  background: rgba(15, 23, 36, 0.7);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  border: 1px solid rgba(77, 163, 255, 0.2);
}

.order-date {
  color: var(--muted);
  font-size: 14px;
  margin-bottom: 10px;
}

.order-items {
  color: #fff;
  margin-bottom: 10px;
}

.order-total {
  color: var(--gold);
  font-weight: 900;
  font-size: 18px;
}

/* Modals */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1002;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s ease;
}

.modal-content {
  background: var(--card);
  padding: 30px;
  border-radius: 15px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  border: 3px solid var(--accent);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.modal-title {
  color: var(--gold);
  font-size: 24px;
  margin: 0;
}

.close-modal {
  background: none;
  border: none;
  color: var(--accent);
  font-size: 28px;
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.3s;
}

.close-modal:hover {
  background: rgba(77, 163, 255, 0.1);
}

/* Loading */
.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1003;
  justify-content: center;
  align-items: center;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 5px solid var(--accent);
  border-top: 5px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Alerts */
.alert {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 25px;
  border-radius: 10px;
  color: white;
  font-weight: bold;
  z-index: 1004;
  animation: slideInRight 0.3s ease;
  max-width: 400px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 12px;
  backdrop-filter: blur(10px);
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.alert-success { background: linear-gradient(135deg, var(--success), #00b894); }
.alert-error { background: linear-gradient(135deg, var(--error), #d63031); }
.alert-warning { background: linear-gradient(135deg, var(--warning), #f39c12); }
.alert-info { background: linear-gradient(135deg, var(--accent), #0077cc); }

/* Footer */
footer {
  text-align: center;
  padding: 30px 20px;
  color: var(--muted);
  margin-top: 50px;
  border-top: 1px solid rgba(77, 163, 255, 0.2);
}

.footer-content {
  max-width: 1000px;
  margin: 0 auto;
}

.footer-links {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 20px 0;
  flex-wrap: wrap;
}

.footer-links a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 700;
  transition: all 0.3s;
}

.footer-links a:hover {
  color: var(--gold);
  text-decoration: underline;
}

/* Responsive */
@media (max-width: 768px) {
  .main-container {
    padding: 0 15px;
  }
  
  .section-card {
    padding: 20px;
  }
  
  .cards-grid,
  .packages-grid,
  .payment-methods {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    grid-template-columns: 1fr;
  }
  
  .main-nav {
    justify-content: flex-start;
    overflow-x: auto;
    padding: 10px 5px;
  }
  
  .nav-btn {
    white-space: nowrap;
    font-size: 14px;
    padding: 8px 12px;
  }
  
  header {
    flex-direction: column;
    gap: 15px;
    padding: 15px;
  }
  
  .user-section {
    width: 100%;
    justify-content: center;
  }
  
  .operator-buttons {
    flex-direction: column;
  }
}

@media (max-width: 480px) {
  .section-title {
    font-size: 22px;
  }
  
  .modal-content {
    padding: 20px;
    width: 95%;
  }
  
  .profile-avatar {
    width: 100px;
    height: 100px;
    font-size: 32px;
  }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- Header -->
<header>
  <a href="#" class="logo" onclick="showSection('products')">
    <i class="fas fa-store"></i>
    <span>MR Store</span>
  </a>
  
  <div class="user-section">
    <!-- زر تسجيل الدخول -->
    <button id="authBtn" onclick="openAuthModal()">
      <i class="fas fa-sign-in-alt"></i>
      <span>تسجيل الدخول</span>
    </button>
    
    <!-- قائمة المستخدم (تظهر بعد التسجيل) -->
    <div id="userMenu" style="display: none;">
      <div class="user-avatar" onclick="toggleUserDropdown()" id="userAvatar">
        <span id="avatarInitials">U</span>
      </div>
      <div class="user-dropdown" id="userDropdown">
        <button onclick="showSection('profile')">
          <i class="fas fa-user"></i>
          الملف الشخصي
        </button>
        <button onclick="showOrderHistory()">
          <i class="fas fa-history"></i>
          طلباتي
        </button>
        <button onclick="openSecuritySettings()">
          <i class="fas fa-shield-alt"></i>
          أسئلة الأمان
        </button>
        <button onclick="logout()" style="color: var(--error);">
          <i class="fas fa-sign-out-alt"></i>
          تسجيل الخروج
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Navigation -->
<nav class="main-nav">
  <button class="nav-btn active" onclick="showSection('products')">
    <i class="fas fa-mobile-alt"></i>
    TOP UP
  </button>
  <button class="nav-btn" onclick="showSection('internet')">
    <i class="fas fa-wifi"></i>
    بطاقات الانترنت
  </button>
  <button class="nav-btn" onclick="showSection('payment')">
    <i class="fas fa-money-bill-wave"></i>
    طرق الدفع
  </button>
</nav>

<!-- Main Content -->
<main class="main-container">
  
  <!-- ========== قسم TOP UP ========== -->
  <section id="productsSection" class="section active">
    <div class="section-card">
      <h2 class="section-title">
        <i class="fas fa-mobile-alt"></i>
        TOP UP - شحن رصيد الألعاب
      </h2>
      
      <!-- اختيار القسم -->
      <div class="category-selector">
        <div class="category-card active" data-category="games" onclick="selectCategory('games')">
          <div class="category-icon">
            <i class="fas fa-gamepad"></i>
          </div>
          <div class="category-name">الألعاب</div>
          <div class="category-desc">باقات الشدة والعملات</div>
        </div>
        
        <div class="category-card" data-category="psn" onclick="selectCategory('psn')">
          <div class="category-icon">
            <i class="fab fa-playstation"></i>
          </div>
          <div class="category-name">بطاقات PSN</div>
          <div class="category-desc">بطاقات بلايستيشن</div>
        </div>
      </div>
      
      <!-- تنبيه الضريبة لـ PSN و Roblox -->
      <div class="tax-warning" id="taxWarning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <p>⚠️ تنبيه: قد يتم تطبيق ضريبة إضافية بسبب الشركات المختصة بالبطاقات الخاصة بـ PlayStation و Roblox</p>
      </div>
      
      <!-- قسم الألعاب -->
      <div id="gamesCategory" class="topup-options active">
        <!-- اختيار اللعبة -->
        <select class="game-select" id="gameSelect" onchange="selectGame()">
          <option value="">اختر اللعبة</option>
          <option value="pubg">PUBG Mobile</option>
          <option value="freefire">Free Fire</option>
          <option value="deltaforce">Delta Force Mobile</option>
          <option value="roblox">Roblox (USA)</option>
          <option value="newstate">PUBG New State</option>
        </select>
        
        <!-- باقات اللعبة -->
        <div id="gamePackages" class="packages-grid" style="display: none;">
          <!-- سيتم ملؤها بالباقات -->
        </div>
        
        <!-- خصم الألعاب -->
        <button class="discount-btn" id="gameDiscountBtn" onclick="applyDiscount('game')">
          <i class="fas fa-tag"></i>
          تطبيق خصم 1.5% على الألعاب
        </button>
      </div>
      
      <!-- قسم PSN -->
      <div id="psnCategory" class="topup-options" style="display: none;">
        <!-- اختيار نوع PSN -->
        <select class="game-select" id="psnRegion" onchange="selectPSNRegion()">
          <option value="">اختر نوع PSN</option>
          <option value="usa">PSN USA</option>
          <option value="sa">PSN SA</option>
        </select>
        
        <!-- باقات PSN -->
        <div id="psnPackages" class="packages-grid" style="display: none;">
          <!-- سيتم ملؤها بالباقات -->
        </div>
        
        <!-- خيارات PSN -->
        <div style="display: flex; gap: 15px; margin: 20px 0;">
          <button class="discount-btn" id="psnDiscountBtn" onclick="applyDiscount('psn')" style="flex: 1;">
            <i class="fas fa-tag"></i>
            خصم 1.5% لـ PSN
          </button>
          
          <select id="psnDelivery" style="flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid var(--accent); border-radius: 10px; color: white;">
            <option value="direct">شحن مباشر للحساب</option>
            <option value="code">استلام كود</option>
          </select>
        </div>
      </div>
      
      <!-- ملخص الطلب -->
      <div class="order-summary-box">
        <h3 class="summary-title">
          <i class="fas fa-receipt"></i>
          ملخص الطلب
        </h3>
        <ul class="selected-packages" id="selectedPackages">
          <li>لم يتم اختيار أي باقة</li>
        </ul>
        <div class="total-price" id="productsTotal">المجموع: 0.00 د.أ</div>
      </div>
      
      <!-- معلومات العميل -->
      <div class="customer-info">
        <h3 style="color: var(--accent); margin-bottom: 20px;">
          <i class="fas fa-user-circle"></i>
          معلومات العميل
        </h3>
        
        <div class="form-group">
          <label for="playerId">
            <i class="fas fa-id-card"></i>
            اسم المستخدم / ID
          </label>
          <input type="text" id="playerId" placeholder="مثال: player123" required>
        </div>
        
        <div class="form-group">
          <label for="instagram">
            <i class="fab fa-instagram"></i>
            حساب الإنستغرام
          </label>
          <input type="text" id="instagram" placeholder="@username" required>
        </div>
        
        <div class="form-group">
          <label for="orderEmail">
            <i class="fas fa-envelope"></i>
            البريد الإلكتروني
          </label>
          <input type="email" id="orderEmail" placeholder="example@gmail.com" required>
        </div>
        
        <div class="form-group">
          <label for="orderNotes">
            <i class="fas fa-edit"></i>
            ملاحظات إضافية
          </label>
          <textarea id="orderNotes" placeholder="أي معلومات إضافية تريد إضافتها..."></textarea>
        </div>
      </div>
      
      <!-- أزرار الإجراء -->
      <div class="action-buttons">
        <button class="btn btn-success" onclick="submitOrder()">
          <i class="fas fa-check-circle"></i>
          تأكيد الطلب
        </button>
        <button class="btn btn-warning" onclick="saveOrderDraft()">
          <i class="fas fa-save"></i>
          حفظ كمسودة
        </button>
        <button class="btn btn-danger" onclick="clearOrder()">
          <i class="fas fa-trash"></i>
          مسح الكل
        </button>
      </div>
      
      <!-- ملاحظات -->
      <div class="note-box">
        <h4 class="note-title">
          <i class="fas fa-info-circle"></i>
          معلومات هامة
        </h4>
        <p>• سيتم التواصل معك عبر GMAIL في حال لم تضف الإنستغرام</p>
        <p>• البريد الإلكتروني للطلبات: <strong>mrsdforstore@gmail.com</strong></p>
        <p>• وقت التسليم: 15-30 دقيقة بعد التأكد من الدفع</p>
      </div>
    </div>
  </section>
  
  <!-- ========== قسم بطاقات الانترنت ========== -->
  <section id="internetSection" class="section">
    <div class="section-card">
      <h2 class="section-title">
        <i class="fas fa-wifi"></i>
        بطاقات الانترنت والمكالمات
      </h2>
      
      <!-- اختيار الشركة -->
      <div class="operator-buttons">
        <button class="operator-btn active" onclick="selectOperator('zain')">
          <i class="fas fa-signal"></i>
          زين
        </button>
      </div>
      
      <!-- اختيار النوع -->
      <div class="type-selector">
        <button class="type-btn active" id="zainCallsBtn" onclick="selectInternetType('zain', 'calls')">
          <i class="fas fa-phone"></i>
          زين مكالمات
        </button>
        <button class="type-btn internet" id="zainInternetBtn" onclick="selectInternetType('zain', 'internet')">
          <i class="fas fa-wifi"></i>
          زين انترنت
        </button>
      </div>
      
      <!-- بطاقات زين -->
      <div id="zainCards" class="cards-grid">
        <!-- زين مكالمات -->
        <div id="zainCallsCards" class="internet-options active">
          <!-- سيتم ملؤها بالبطاقات -->
        </div>
        
        <!-- زين انترنت -->
        <div id="zainInternetCards" class="internet-options">
          <!-- سيتم ملؤها بالبطاقات -->
        </div>
      </div>
      
      <!-- نموذج طلب البطاقات -->
      <div class="customer-info">
        <h3 style="color: var(--accent); margin-bottom: 20px;">
          <i class="fas fa-shopping-cart"></i>
          نموذج طلب البطاقات
        </h3>
        
        <div class="form-group">
          <label for="cardsEmail">
            <i class="fas fa-envelope"></i>
            البريد الإلكتروني *
          </label>
          <input type="email" id="cardsEmail" placeholder="example@gmail.com" required>
          <small style="color: var(--muted); display: block; margin-top: 5px;">
            سيتم إرسال الكود إلى هذا الإيميل
          </small>
        </div>
        
        <div class="form-group">
          <label for="cardsPhone">
            <i class="fas fa-phone"></i>
            رقم الهاتف (اختياري)
          </label>
          <input type="tel" id="cardsPhone" placeholder="07XXXXXXXX">
        </div>
        
        <div class="form-group">
          <label for="cardsNotes">
            <i class="fas fa-edit"></i>
            ملاحظات إضافية
          </label>
          <textarea id="cardsNotes" placeholder="أي معلومات إضافية للطلب..."></textarea>
        </div>
        
        <!-- ملخص طلب البطاقات -->
        <div class="order-summary-box">
          <h3 class="summary-title">
            <i class="fas fa-receipt"></i>
            ملخص طلب البطاقات
          </h3>
          <ul class="selected-packages" id="selectedCards">
            <li>لم يتم اختيار أي بطاقة</li>
          </ul>
          <div class="total-price" id="cardsTotal">المجموع: 0.00 د.أ</div>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-success" onclick="submitCardsOrder()">
            <i class="fas fa-check-circle"></i>
            تأكيد طلب البطاقات
          </button>
          <button class="btn btn-danger" onclick="clearCardsSelection()">
            <i class="fas fa-trash"></i>
            مسح الكل
          </button>
        </div>
      </div>
      
      <!-- ملاحظات -->
      <div class="note-box">
        <h4 class="note-title">
          <i class="fas fa-info-circle"></i>
          معلومات هامة
        </h4>
        <p>• البريد الإلكتروني للطلبات: <strong>mrsdforstore@gmail.com</strong></p>
        <p>• وقت التسليم: 15-30 دقيقة بعد التأكد من الدفع</p>
      </div>
    </div>
  </section>
  
  <!-- ========== قسم طرق الدفع ========== -->
  <section id="paymentSection" class="section">
    <div class="section-card">
      <h2 class="section-title">
        <i class="fas fa-money-bill-wave"></i>
        طرق الدفع المتاحة
      </h2>
      
      <div class="payment-methods">
        <!-- PayPal -->
        <div class="payment-method">
          <div class="payment-icon" style="color: var(--paypal);">
            <i class="fab fa-paypal"></i>
          </div>
          <h3 class="payment-name">PayPal</h3>
          <p class="payment-desc">الدفع عبر PayPal</p>
          <button class="copy-btn" onclick="copyToClipboard('PayPal QR Code: https://www.paypal.com/qrcodes/p2pqrc/LMSNFX9T2WDP4')">
            <i class="fas fa-copy"></i>
            نسخ الرابط
          </button>
        </div>
        
        <!-- U Wallet -->
        <div class="payment-method">
          <div class="payment-icon">
            <i class="fas fa-wallet"></i>
          </div>
          <h3 class="payment-name">U Wallet</h3>
          <p class="payment-desc">محفظة U Wallet الإلكترونية</p>
          <button class="copy-btn" onclick="copyToClipboard('U Wallet - MRSDFOR')">
            <i class="fas fa-copy"></i>
            نسخ الاسم
          </button>
        </div>
        
        <!-- Zain Cash -->
        <div class="payment-method">
          <div class="payment-icon">
            <i class="fas fa-mobile-alt"></i>
          </div>
          <h3 class="payment-name">Zain Cash</h3>
          <p class="payment-desc">خدمة زين كاش للتحويل</p>
          <button class="copy-btn" onclick="copyToClipboard('Zain Cash - MRSDFOR')">
            <i class="fas fa-copy"></i>
            نسخ الرقم
          </button>
        </div>
        
        <!-- Orange Money -->
        <div class="payment-method">
          <div class="payment-icon">
            <i class="fas fa-money-bill"></i>
          </div>
          <h3 class="payment-name">Orange Money</h3>
          <p class="payment-desc">خدمة أورنج موني</p>
          <button class="copy-btn" onclick="copyToClipboard('Orange Money - MRSDFOR')">
            <i class="fas fa-copy"></i>
            نسخ الرقم
          </button>
        </div>
      </div>
      
      <!-- PayPal QR Code -->
      <div class="paypal-section">
        <h3 class="paypal-title">
          <i class="fab fa-paypal"></i>
          الدفع عبر PayPal
        </h3>
        
        <div class="paypal-qr">
          <!-- QR Code Placeholder -->
          <div style="text-align: center; padding: 20px; color: #000;">
            <i class="fab fa-paypal" style="font-size: 50px; color: var(--paypal); margin-bottom: 10px;"></i>
            <p style="font-weight: bold; margin: 10px 0;">PayPal QR Code</p>
            <p style="font-size: 14px; color: #666;">Scan to Pay</p>
          </div>
        </div>
        
        <a href="https://www.paypal.com/qrcodes/p2pqrc/LMSNFX9T2WDP4" target="_blank" class="paypal-link">
          <i class="fas fa-external-link-alt"></i>
          فتح رابط PayPal
        </a>
        
        <p style="margin-top: 15px; color: var(--muted);">
          رابط PayPal: https://www.paypal.com/qrcodes/p2pqrc/LMSNFX9T2WDP4
        </p>
      </div>
      
      <!-- معلومات التحويل -->
      <div class="customer-info" style="text-align: center;">
        <h3 style="color: var(--gold); margin-bottom: 15px; font-size: 24px;">
          الاسم المستعار للتحويل
        </h3>
        <div style="background: rgba(255,215,0,0.1); padding: 20px; border-radius: 10px; border: 2px solid var(--gold);">
          <p style="font-size: 20px; margin-bottom: 10px; color: var(--accent);">الاسم:</p>
          <h2 id="aliasName" style="color: var(--gold); font-size: 32px; font-weight: 900; margin: 10px 0;">MRSDFOR</h2>
          <button class="btn btn-primary" onclick="copyToClipboard('MRSDFOR')" style="margin-top: 15px;">
            <i class="fas fa-copy"></i>
            نسخ الاسم المستعار
          </button>
        </div>
      </div>
      
      <!-- تعليمات الدفع -->
      <div class="note-box">
        <h4 class="note-title">
          <i class="fas fa-lightbulb"></i>
          تعليمات الدفع
        </h4>
        <p>• في حال دعم التحويل عبر الاسم المستعار يرجى التحويل للاسم</p>
        <p>• في حال عدم دعمه يرجى وضع رقم واتساب داخل الملاحظات</p>
        <p>• تأكد من إرسال إيصال الدفع مع طلبك</p>
        <p>• الدفع يكون مقدماً قبل إرسال المنتج</p>
      </div>
      
      <div class="note-box important">
        <h4 class="note-title important">
          <i class="fas fa-exclamation-triangle"></i>
          تنبيهات هامة
        </h4>
        <p>• لن يتم إرسال أي منتج قبل التأكد من استلام الدفع</p>
        <p>• يرجى الاحتفاظ بإيصال الدفع</p>
        <p>• للاستفسارات: <strong>mrsdforstore@gmail.com</strong></p>
      </div>
    </div>
  </section>
  
  <!-- ========== الملف الشخصي ========== -->
  <section id="profileSection" class="section">
    <div class="section-card">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">
          <span id="profileInitials">U</span>
        </div>
        <h2 class="profile-name" id="displayName">اسم المستخدم</h2>
        <p class="profile-email" id="displayEmail">user@example.com</p>
        <p style="color: var(--muted); margin-top: 10px;">
          <i class="fas fa-calendar"></i>
          عضو منذ: <span id="memberSince">2025-01-01</span>
        </p>
      </div>
      
      <!-- إحصائيات المستخدم -->
      <div class="profile-stats">
        <div class="stat-card">
          <div class="stat-value" id="totalOrders">0</div>
          <div class="stat-label">الطلبات</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalSpent">0.00</div>
          <div class="stat-label">دينار</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="memberDays">1</div>
          <div class="stat-label">يوم</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="successRate">100%</div>
          <div class="stat-label">نجاح</div>
        </div>
      </div>
      
      <!-- تعديل الملف -->
      <div class="customer-info">
        <h3 style="color: var(--accent); margin-bottom: 20px;">
          <i class="fas fa-edit"></i>
          تعديل الملف الشخصي
        </h3>
        
        <div class="form-group">
          <label for="editName">الاسم الكامل</label>
          <input type="text" id="editName" placeholder="اسمك الكامل">
        </div>
        
        <div class="form-group">
          <label for="editEmail">البريد الإلكتروني</label>
          <input type="email" id="editEmail" placeholder="بريدك الإلكتروني">
        </div>
        
        <div class="form-group">
          <label for="editPhone">رقم الهاتف</label>
          <input type="tel" id="editPhone" placeholder="رقم هاتفك">
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="updateProfile()" style="flex: 1;">
            <i class="fas fa-save"></i>
            حفظ التغييرات
          </button>
          <button class="btn btn-warning" onclick="openChangePasswordModal()" style="flex: 1;">
            <i class="fas fa-key"></i>
            تغيير كلمة السر
          </button>
        </div>
      </div>
      
      <!-- سجل الطلبات -->
      <div>
        <h3 style="color: var(--gold); margin: 30px 0 20px; font-size: 22px;">
          <i class="fas fa-history"></i>
          سجل الطلبات
        </h3>
        <div class="order-history" id="orderHistory">
          <div class="order-card">
            <div class="order-date">لا توجد طلبات سابقة</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modals -->

<!-- Modal تسجيل الدخول -->
<div id="authModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-sign-in-alt"></i>
        تسجيل الدخول
      </h3>
      <button class="close-modal" onclick="closeModal('authModal')">&times;</button>
    </div>
    
    <div class="form-group">
      <label for="loginEmail">البريد الإلكتروني</label>
      <input type="email" id="loginEmail" placeholder="example@gmail.com">
    </div>
    
    <div class="form-group">
      <label for="loginPassword">كلمة المرور</label>
      <input type="password" id="loginPassword" placeholder="كلمة المرور">
    </div>
    
    <div style="margin: 20px 0;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" id="rememberMe" style="width: auto;">
        <span>تذكرني</span>
      </label>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="btn btn-success" onclick="login()" style="flex: 2;">
        <i class="fas fa-sign-in-alt"></i>
        دخول
      </button>
      <button class="btn btn-primary" onclick="switchToRegister()" style="flex: 1;">
        <i class="fas fa-user-plus"></i>
        حساب جديد
      </button>
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
      <a href="#" style="color: var(--accent); text-decoration: none;" onclick="openForgotPasswordModal()">
        نسيت كلمة المرور؟
      </a>
    </div>
  </div>
</div>

<!-- Modal التسجيل -->
<div id="registerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-user-plus"></i>
        إنشاء حساب جديد
      </h3>
      <button class="close-modal" onclick="closeModal('registerModal')">&times;</button>
    </div>
    
    <div class="form-group">
      <label for="registerName">الاسم الكامل</label>
      <input type="text" id="registerName" placeholder="الاسم الكامل">
    </div>
    
    <div class="form-group">
      <label for="registerEmail">البريد الإلكتروني</label>
      <input type="email" id="registerEmail" placeholder="example@gmail.com">
    </div>
    
    <div class="form-group">
      <label for="registerPassword">كلمة المرور</label>
      <input type="password" id="registerPassword" placeholder="كلمة المرور (6 أحرف على الأقل)">
    </div>
    
    <div class="form-group">
      <label for="registerConfirm">تأكيد كلمة المرور</label>
      <input type="password" id="registerConfirm" placeholder="أعد إدخال كلمة المرور">
    </div>
    
    <div class="form-group">
      <label for="registerPhone">رقم الهاتف (اختياري)</label>
      <input type="tel" id="registerPhone" placeholder="07XXXXXXXX">
    </div>
    
    <!-- أسئلة الأمان -->
    <div class="form-group">
      <label for="securityQuestion1">سؤال الأمان الأول</label>
      <select id="securityQuestion1">
        <option value="">اختر سؤال الأمان</option>
        <option value="pet">ما اسم حيوانك الأليف الأول؟</option>
        <option value="school">ما هي مدرستك الابتدائية؟</option>
        <option value="city">ما هي مدينتك الأم؟</option>
        <option value="mother">ما اسم والدتك قبل الزواج؟</option>
        <option value="car">ما هي أول سيئة امتلكتها؟</option>
      </select>
      <input type="text" id="securityAnswer1" placeholder="الإجابة" style="margin-top: 10px;">
    </div>
    
    <div class="form-group">
      <label for="securityQuestion2">سؤال الأمان الثاني</label>
      <select id="securityQuestion2">
        <option value="">اختر سؤال الأمان</option>
        <option value="pet">ما اسم حيوانك الأليف الأول؟</option>
        <option value="school">ما هي مدرستك الابتدائية؟</option>
        <option value="city">ما هي مدينتك الأم؟</option>
        <option value="mother">ما اسم والدتك قبل الزواج؟</option>
        <option value="car">ما هي أول سيئة امتلكتها؟</option>
      </select>
      <input type="text" id="securityAnswer2" placeholder="الإجابة" style="margin-top: 10px;">
    </div>
    
    <div style="margin: 20px 0;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" id="acceptTerms" style="width: auto;">
        <span>أوافق على <a href="#" style="color: var(--accent);">الشروط والأحكام</a></span>
      </label>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="btn btn-success" onclick="register()" style="flex: 2;">
        <i class="fas fa-user-plus"></i>
        إنشاء الحساب
      </button>
      <button class="btn btn-primary" onclick="switchToLogin()" style="flex: 1;">
        <i class="fas fa-sign-in-alt"></i>
        لدي حساب
      </button>
    </div>
  </div>
</div>

<!-- Modal نسيت كلمة المرور -->
<div id="forgotPasswordModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-key"></i>
        استعادة كلمة المرور
      </h3>
      <button class="close-modal" onclick="closeModal('forgotPasswordModal')">&times;</button>
    </div>
    
    <div id="forgotStep1">
      <div class="form-group">
        <label for="forgotEmail">البريد الإلكتروني</label>
        <input type="email" id="forgotEmail" placeholder="أدخل بريدك الإلكتروني">
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button class="btn btn-primary" onclick="forgotPasswordStep1()" style="flex: 1;">
          <i class="fas fa-search"></i>
          البحث عن الحساب
        </button>
        <button class="btn btn-danger" onclick="closeModal('forgotPasswordModal')" style="flex: 1;">
          <i class="fas fa-times"></i>
          إلغاء
        </button>
      </div>
    </div>
    
    <div id="forgotStep2" style="display: none;">
      <div class="form-group">
        <label id="securityQuestionLabel">سؤال الأمان</label>
        <input type="text" id="securityAnswer" placeholder="أدخل إجابة سؤال الأمان">
      </div>
      
      <div class="form-group">
        <label for="newPassword">كلمة المرور الجديدة</label>
        <input type="password" id="newPassword" placeholder="كلمة المرور الجديدة">
      </div>
      
      <div class="form-group">
        <label for="confirmNewPassword">تأكيد كلمة المرور الجديدة</label>
        <input type="password" id="confirmNewPassword" placeholder="أعد إدخال كلمة المرور الجديدة">
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button class="btn btn-success" onclick="resetPassword()" style="flex: 1;">
          <i class="fas fa-check-circle"></i>
          تغيير كلمة المرور
        </button>
        <button class="btn btn-danger" onclick="closeModal('forgotPasswordModal')" style="flex: 1;">
          <i class="fas fa-times"></i>
          إلغاء
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal تغيير كلمة المرور -->
<div id="changePasswordModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-key"></i>
        تغيير كلمة المرور
      </h3>
      <button class="close-modal" onclick="closeModal('changePasswordModal')">&times;</button>
    </div>
    
    <div class="form-group">
      <label for="currentPassword">كلمة المرور الحالية</label>
      <input type="password" id="currentPassword" placeholder="كلمة المرور الحالية">
    </div>
    
    <div class="form-group">
      <label for="newPasswordProfile">كلمة المرور الجديدة</label>
      <input type="password" id="newPasswordProfile" placeholder="كلمة المرور الجديدة (6 أحرف على الأقل)">
    </div>
    
    <div class="form-group">
      <label for="confirmNewPasswordProfile">تأكيد كلمة المرور الجديدة</label>
      <input type="password" id="confirmNewPasswordProfile" placeholder="أعد إدخال كلمة المرور الجديدة">
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="btn btn-success" onclick="changePassword()" style="flex: 1;">
        <i class="fas fa-check-circle"></i>
        تغيير كلمة المرور
      </button>
      <button class="btn btn-danger" onclick="closeModal('changePasswordModal')" style="flex: 1;">
        <i class="fas fa-times"></i>
        إلغاء
      </button>
    </div>
  </div>
</div>

<!-- Modal أسئلة الأمان -->
<div id="securitySettingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-shield-alt"></i>
        أسئلة الأمان
      </h3>
      <button class="close-modal" onclick="closeModal('securitySettingsModal')">&times;</button>
    </div>
    
    <div id="securityQuestionsInfo" style="margin-bottom: 20px;">
      <!-- سيتم ملؤها بمعلومات أسئلة الأمان -->
    </div>
    
    <div class="form-group">
      <label for="editSecurityQuestion1">تعديل سؤال الأمان الأول</label>
      <select id="editSecurityQuestion1">
        <option value="">اختر سؤال الأمان</option>
        <option value="pet">ما اسم حيوانك الأليف الأول؟</option>
        <option value="school">ما هي مدرستك الابتدائية؟</option>
        <option value="city">ما هي مدينتك الأم؟</option>
        <option value="mother">ما اسم والدتك قبل الزواج؟</option>
        <option value="car">ما هي أول سيئة امتلكتها؟</option>
      </select>
      <input type="text" id="editSecurityAnswer1" placeholder="الإجابة الجديدة" style="margin-top: 10px;">
    </div>
    
    <div class="form-group">
      <label for="editSecurityQuestion2">تعديل سؤال الأمان الثاني</label>
      <select id="editSecurityQuestion2">
        <option value="">اختر سؤال الأمان</option>
        <option value="pet">ما اسم حيوانك الأليف الأول؟</option>
        <option value="school">ما هي مدرستك الابتدائية؟</option>
        <option value="city">ما هي مدينتك الأم؟</option>
        <option value="mother">ما اسم والدتك قبل الزواج؟</option>
        <option value="car">ما هي أول سيئة امتلكتها؟</option>
      </select>
      <input type="text" id="editSecurityAnswer2" placeholder="الإجابة الجديدة" style="margin-top: 10px;">
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button class="btn btn-success" onclick="updateSecurityQuestions()" style="flex: 1;">
        <i class="fas fa-save"></i>
        حفظ التغييرات
      </button>
      <button class="btn btn-danger" onclick="closeModal('securitySettingsModal')" style="flex: 1;">
        <i class="fas fa-times"></i>
        إلغاء
      </button>
    </div>
  </div>
</div>

<!-- Modal تأكيد الطلب -->
<div id="orderModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-check-circle"></i>
        تأكيد الطلب
      </h3>
      <button class="close-modal" onclick="closeModal('orderModal')">&times;</button>
    </div>
    
    <div id="orderDetails" style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
      <!-- سيتم ملؤها بالتفاصيل -->
    </div>
    
    <div class="note-box" style="margin-bottom: 20px;">
      <h4 class="note-title">
        <i class="fas fa-info-circle"></i>
        تعليمات
      </h4>
      <p>1. انسخ تفاصيل الطلب وأرسلها إلى بريدنا الإلكتروني</p>
      <p>2. أو اضغط على "فتح البريد" لإرسالها مباشرة</p>
      <p>3. تأكد من إضافة إيصال الدفع عند الإرسال</p>
      <p>4. البريد الإلكتروني: <strong>mrsdforstore@gmail.com</strong></p>
    </div>
    
    <div style="display: flex; gap: 10px;">
      <button class="btn btn-success" onclick="copyOrder()" style="flex: 1;">
        <i class="fas fa-copy"></i>
        نسخ الطلب
      </button>
      <button class="btn btn-primary" onclick="openOrderEmail()" style="flex: 1;">
        <i class="fas fa-envelope"></i>
        فتح البريد
      </button>
      <button class="btn btn-danger" onclick="closeModal('orderModal')" style="flex: 1;">
        <i class="fas fa-times"></i>
        إغلاق
      </button>
    </div>
  </div>
</div>

<!-- Loading Screen -->
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
</div>

<!-- Footer -->
<footer>
  <div class="footer-content">
    <div class="logo" style="justify-content: center; margin-bottom: 20px;">
      <i class="fas fa-store"></i>
      <span>MR Store</span>
    </div>
    
    <div class="footer-links">
      <a href="#" onclick="showSection('products')">TOP UP</a>
      <a href="#" onclick="showSection('internet')">بطاقات الانترنت</a>
      <a href="#" onclick="showSection('payment')">طرق الدفع</a>
    </div>
    
    <p style="margin: 20px 0;">
      <i class="fas fa-envelope"></i>
      البريد الإلكتروني: mrsdforstore@gmail.com
    </p>
    
    <p style="color: var(--muted); font-size: 14px;">
      © 2025 MR Store. جميع الحقوق محفوظة.
    </p>
  </div>
</footer>

<script>
// ================= البيانات الأساسية =================
const DATA = {
  games: {
    pubg: [
      { name: "30 شدة", price: 0.40, desc: "30 UC" },
      { name: "60 شدة", price: 0.70, desc: "60 UC" },
      { name: "300+25 شدة", price: 3.25, desc: "325 UC" },
      { name: "600+60 شدة", price: 6.35, desc: "660 UC" },
      { name: "1500+300 شدة", price: 15.70, desc: "1800 UC" }
    ],
    freefire: [
      { name: "110 جواهر", price: 0.75, desc: "110 Diamond" },
      { name: "231 جوهرة", price: 1.45, desc: "231 Diamond" },
      { name: "583 جوهرة", price: 3.50, desc: "583 Diamond" },
      { name: "1188 جوهرة", price: 6.90, desc: "1188 Diamond" },
      { name: "2420 جوهرة", price: 13.80, desc: "2420 Diamond" }
    ],
    deltaforce: [
      { name: "19 ذهبة", price: 0.30, desc: "19 Gold" },
      { name: "32 ذهبة", price: 0.45, desc: "32 Gold" },
      { name: "63 ذهبة", price: 0.80, desc: "63 Gold" },
      { name: "336 ذهبة", price: 4.00, desc: "336 Gold" },
      { name: "482 ذهبة", price: 5.50, desc: "482 Gold" },
      { name: "785 ذهبة", price: 7.40, desc: "785 Gold" }
    ],
    roblox: [
      { name: "$10", price: 7.60, desc: "$10" },
      { name: "$20", price: 14.60, desc: "$20" },
      { name: "$25", price: 18.00, desc: "$25" },
      { name: "$40", price: 28.60, desc: "$40" },
      { name: "$50", price: 35.65, desc: "$50" },
      { name: "$100", price: 71.00, desc: "$100" }
    ],
    newstate: [
      { name: "300 NC", price: 1.00, desc: "300 NC" },
      { name: "1500+80 NC", price: 3.80, desc: "1580 NC" },
      { name: "3600+250 NC", price: 8.90, desc: "3850 NC" },
      { name: "9300+930 NC", price: 22.50, desc: "10230 NC" }
    ]
  },
  psn: {
    usa: [
      { name: "$10", price: 7.20, desc: "PSN USA $10" },
      { name: "$25", price: 17.85, desc: "PSN USA $25" },
      { name: "$50", price: 32.80, desc: "PSN USA $50" },
      { name: "$55", price: 39.50, desc: "PSN USA $55" },
      { name: "$75", price: 53.50, desc: "PSN USA $75" }
    ],
    sa: [
      { name: "$10", price: 8.25, desc: "PSN SA $10" },
      { name: "$20", price: 15.20, desc: "PSN SA $20" },
      { name: "$40", price: 30.40, desc: "PSN SA $40" },
      { name: "$50", price: 37.75, desc: "PSN SA $50" },
      { name: "$70", price: 52.35, desc: "PSN SA $70" }
    ]
  },
  zain: {
    calls: [
      { name: "0.50 دينار مكالمات", price: 0.90, desc: "رصيد مكالمات 0.50 دينار" },
      { name: "1 دينار مكالمات", price: 1.65, desc: "رصيد مكالمات 1 دينار" },
      { name: "3 دينار مكالمات", price: 4.60, desc: "رصيد مكالمات 3 دينار" },
      { name: "5 دينار مكالمات", price: 7.60, desc: "رصيد مكالمات 5 دينار" },
      { name: "6 دينار مكالمات", price: 9.15, desc: "رصيد مكالمات 6 دينار" },
      { name: "9 دينار مكالمات", price: 13.55, desc: "رصيد مكالمات 9 دينار" }
    ],
    internet: [
      { name: "1 جيجا انترنت", price: 1.30, desc: "باقة انترنت 1 جيجابايت" },
      { name: "2 جيجا انترنت", price: 2.50, desc: "باقة انترنت 2 جيجابايت" },
      { name: "3 جيجا انترنت", price: 3.70, desc: "باقة انترنت 3 جيجابايت" },
      { name: "4 جيجا انترنت", price: 4.90, desc: "باقة انترنت 4 جيجابايت" },
      { name: "5 جيجا انترنت", price: 6.15, desc: "باقة انترنت 5 جيجابايت" },
      { name: "6 جيجا انترنت", price: 7.25, desc: "باقة انترنت 6 جيجابايت" },
      { name: "8 جيجا انترنت", price: 9.85, desc: "باقة انترنت 8 جيجابايت" },
      { name: "9 جيجا انترنت", price: 10.80, desc: "باقة انترنت 9 جيجابايت" }
    ]
  }
};

// ================= المتغيرات العامة =================
let currentUser = null;
let selectedCategory = 'games';
let selectedGame = '';
let selectedPSNRegion = '';
let selectedPackages = [];
let selectedCards = [];
let gameDiscountApplied = false;
let psnDiscountApplied = false;
let totalPrice = 0;
let cardsTotalPrice = 0;
let currentOperator = 'zain';
let currentInternetType = 'calls';

// أسئلة الأمان المتاحة
const SECURITY_QUESTIONS = {
  pet: "ما اسم حيوانك الأليف الأول؟",
  school: "ما هي مدرستك الابتدائية؟",
  city: "ما هي مدينتك الأم؟",
  mother: "ما اسم والدتك قبل الزواج؟",
  car: "ما هي أول سيئة امتلكتها؟"
};

// ================= تهيئة الصفحة =================
document.addEventListener('DOMContentLoaded', function() {
  // تحميل حالة المستخدم من localStorage
  loadUserFromStorage();
  
  // تحميل بطاقات زين
  loadZainCards();
  
  // إضافة اختصارات لوحة المفاتيح
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
      if (document.getElementById('productsSection').classList.contains('active')) {
        submitOrder();
      } else if (document.getElementById('internetSection').classList.contains('active')) {
        submitCardsOrder();
      }
    }
  });
  
  // تحديث الوقت في الملف الشخصي
  updateProfileTime();
});

// ================= إدارة المستخدمين =================
function loadUserFromStorage() {
  const savedUser = localStorage.getItem('mrStoreUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    showUserMenu();
    updateProfileDisplay();
    updateProfileTime();
  }
}

function showUserMenu() {
  document.getElementById('authBtn').style.display = 'none';
  document.getElementById('userMenu').style.display = 'flex';
}

function openAuthModal() {
  document.getElementById('authModal').style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

function switchToRegister() {
  closeModal('authModal');
  document.getElementById('registerModal').style.display = 'flex';
}

function switchToLogin() {
  closeModal('registerModal');
  document.getElementById('authModal').style.display = 'flex';
}

function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    showAlert('يرجى ملء جميع الحقول', 'error');
    return;
  }
  
  // محاكاة تسجيل الدخول
  const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
  const user = users.find(u => u.email === email && u.password === password);
  
  if (user) {
    currentUser = user;
    localStorage.setItem('mrStoreUser', JSON.stringify(user));
    showUserMenu();
    updateProfileDisplay();
    updateProfileTime();
    closeModal('authModal');
    showAlert('تم تسجيل الدخول بنجاح', 'success');
    
    // تحديث تذكرني
    const rememberMe = document.getElementById('rememberMe').checked;
    if (rememberMe) {
      localStorage.setItem('mrStoreRemember', email);
    }
  } else {
    showAlert('البريد الإلكتروني أو كلمة المرور غير صحيحة', 'error');
  }
}

function register() {
  const name = document.getElementById('registerName').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;
  const confirm = document.getElementById('registerConfirm').value;
  const phone = document.getElementById('registerPhone').value.trim();
  const acceptTerms = document.getElementById('acceptTerms').checked;
  
  // التحقق من البيانات
  if (!name || !email || !password || !confirm) {
    showAlert('يرجى ملء جميع الحقول المطلوبة', 'error');
    return;
  }
  
  if (password !== confirm) {
    showAlert('كلمات المرور غير متطابقة', 'error');
    return;
  }
  
  if (password.length < 6) {
    showAlert('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
    return;
  }
  
  // التحقق من أسئلة الأمان
  const securityQuestion1 = document.getElementById('securityQuestion1').value;
  const securityAnswer1 = document.getElementById('securityAnswer1').value.trim();
  const securityQuestion2 = document.getElementById('securityQuestion2').value;
  const securityAnswer2 = document.getElementById('securityAnswer2').value.trim();
  
  if (!securityQuestion1 || !securityAnswer1 || !securityQuestion2 || !securityAnswer2) {
    showAlert('يرجى إكمال أسئلة الأمان', 'error');
    return;
  }
  
  if (!acceptTerms) {
    showAlert('يجب الموافقة على الشروط والأحكام', 'error');
    return;
  }
  
  // التحقق من البريد الإلكتروني
  const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
  if (users.some(u => u.email === email)) {
    showAlert('هذا البريد الإلكتروني مسجل بالفعل', 'error');
    return;
  }
  
  // إنشاء المستخدم الجديد
  const newUser = {
    id: Date.now(),
    name: name,
    email: email,
    password: password,
    phone: phone,
    createdAt: new Date().toISOString(),
    orders: [],
    totalSpent: 0,
    securityQuestions: {
      question1: securityQuestion1,
      answer1: securityAnswer1.toLowerCase(),
      question2: securityQuestion2,
      answer2: securityAnswer2.toLowerCase()
    }
  };
  
  users.push(newUser);
  localStorage.setItem('mrStoreUsers', JSON.stringify(users));
  
  // تسجيل الدخول تلقائياً
  currentUser = newUser;
  localStorage.setItem('mrStoreUser', JSON.stringify(newUser));
  
  showUserMenu();
  updateProfileDisplay();
  updateProfileTime();
  closeModal('registerModal');
  showAlert('تم إنشاء الحساب بنجاح!', 'success');
}

function logout() {
  currentUser = null;
  localStorage.removeItem('mrStoreUser');
  document.getElementById('authBtn').style.display = 'flex';
  document.getElementById('userMenu').style.display = 'none';
  showSection('products');
  showAlert('تم تسجيل الخروج', 'info');
}

function updateProfile() {
  if (!currentUser) {
    showAlert('يرجى تسجيل الدخول أولاً', 'error');
    return;
  }
  
  const name = document.getElementById('editName').value.trim();
  const email = document.getElementById('editEmail').value.trim();
  const phone = document.getElementById('editPhone').value.trim();
  
  if (!name || !email) {
    showAlert('يرجى ملء الحقول المطلوبة', 'error');
    return;
  }
  
  // التحقق من البريد الإلكتروني (إذا تغير)
  if (email !== currentUser.email) {
    const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
    if (users.some(u => u.email === email && u.id !== currentUser.id)) {
      showAlert('هذا البريد الإلكتروني مسجل بالفعل', 'error');
      return;
    }
  }
  
  // تحديث بيانات المستخدم
  const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
  const userIndex = users.findIndex(u => u.id === currentUser.id);
  
  if (userIndex > -1) {
    users[userIndex].name = name;
    users[userIndex].email = email;
    users[userIndex].phone = phone;
    
    localStorage.setItem('mrStoreUsers', JSON.stringify(users));
    currentUser = users[userIndex];
    localStorage.setItem('mrStoreUser', JSON.stringify(currentUser));
    
    showUserMenu();
    updateProfileDisplay();
    showAlert('تم تحديث الملف الشخصي', 'success');
  }
}

function updateProfileDisplay() {
  if (currentUser) {
    document.getElementById('displayName').textContent = currentUser.name;
    document.getElementById('displayEmail').textContent = currentUser.email;
    document.getElementById('avatarInitials').textContent = currentUser.name.charAt(0).toUpperCase();
    document.getElementById('profileInitials').textContent = currentUser.name.charAt(0).toUpperCase();
    document.getElementById('editName').value = currentUser.name;
    document.getElementById('editEmail').value = currentUser.email;
    document.getElementById('editPhone').value = currentUser.phone || '';
    
    // تحديث الإحصائيات
    document.getElementById('totalOrders').textContent = currentUser.orders?.length || 0;
    document.getElementById('totalSpent').textContent = (currentUser.totalSpent || 0).toFixed(2);
    
    // تحديث سجل الطلبات
    updateOrderHistory();
  }
}

function updateProfileTime() {
  if (currentUser) {
    const joinDate = new Date(currentUser.createdAt);
    const now = new Date();
    const diffTime = Math.abs(now - joinDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    document.getElementById('memberDays').textContent = diffDays;
    document.getElementById('memberSince').textContent = joinDate.toLocaleDateString('ar-JO');
    
    // حساب نسبة النجاح
    const totalOrders = currentUser.orders?.length || 0;
    const successRate = totalOrders > 0 ? 100 : 0;
    document.getElementById('successRate').textContent = successRate + '%';
  }
}

// ================= نسيت كلمة المرور =================
function openForgotPasswordModal() {
  closeModal('authModal');
  document.getElementById('forgotPasswordModal').style.display = 'flex';
  document.getElementById('forgotStep1').style.display = 'block';
  document.getElementById('forgotStep2').style.display = 'none';
  document.getElementById('forgotEmail').value = '';
  document.getElementById('securityAnswer').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmNewPassword').value = '';
}

function forgotPasswordStep1() {
  const email = document.getElementById('forgotEmail').value.trim();
  
  if (!email) {
    showAlert('يرجى إدخال البريد الإلكتروني', 'error');
    return;
  }
  
  if (!validateEmail(email)) {
    showAlert('يرجى إدخال بريد إلكتروني صحيح', 'error');
    return;
  }
  
  // البحث عن المستخدم
  const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
  const user = users.find(u => u.email === email);
  
  if (!user) {
    showAlert('لا يوجد حساب مسجل بهذا البريد الإلكتروني', 'error');
    return;
  }
  
  // حفظ بيانات المستخدم مؤقتاً
  sessionStorage.setItem('forgotPasswordUser', JSON.stringify(user));
  
  // عرض سؤال الأمان
  const securityQuestion = SECURITY_QUESTIONS[user.securityQuestions.question1];
  document.getElementById('securityQuestionLabel').textContent = securityQuestion;
  
  // الانتقال للخطوة الثانية
  document.getElementById('forgotStep1').style.display = 'none';
  document.getElementById('forgotStep2').style.display = 'block';
}

function resetPassword() {
  const answer = document.getElementById('securityAnswer').value.trim().toLowerCase();
  const newPassword = document.getElementById('newPassword').value;
  const confirmNewPassword = document.getElementById('confirmNewPassword').value;
  
  if (!answer || !newPassword || !confirmNewPassword) {
    showAlert('يرجى ملء جميع الحقول', 'error');
    return;
  }
  
  if (newPassword !== confirmNewPassword) {
    showAlert('كلمات المرور غير متطابقة', 'error');
    return;
  }
  
  if (newPassword.length < 6) {
    showAlert('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
    return;
  }
  
  // التحقق من بيانات المستخدم المؤقتة
  const userData = sessionStorage.getItem('forgotPasswordUser');
  if (!userData) {
    showAlert('انتهت جلسة الاستعادة، يرجى المحاولة مرة أخرى', 'error');
    return;
  }
  
  const user = JSON.parse(userData);
  
  // التحقق من إجابة سؤال الأمان
  if (answer !== user.securityQuestions.answer1) {
    showAlert('إجابة سؤال الأمان غير صحيحة', 'error');
    return;
  }
  
  // تحديث كلمة المرور
  const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
  const userIndex = users.findIndex(u => u.id === user.id);
  
  if (userIndex > -1) {
    users[userIndex].password = newPassword;
    localStorage.setItem('mrStoreUsers', JSON.stringify(users));
    
    // تنظيف البيانات المؤقتة
    sessionStorage.removeItem('forgotPasswordUser');
    
    // إغلاق النافذة وإظهار رسالة النجاح
    closeModal('forgotPasswordModal');
    showAlert('تم تغيير كلمة المرور بنجاح، يمكنك الآن تسجيل الدخول', 'success');
    
    // فتح نافذة تسجيل الدخول
    setTimeout(() => {
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('loginEmail').value = user.email;
    }, 1000);
  }
}

// ================= تغيير كلمة المرور =================
function openChangePasswordModal() {
  if (!currentUser) {
    showAlert('يرجى تسجيل الدخول أولاً', 'error');
    return;
  }
  
  document.getElementById('changePasswordModal').style.display = 'flex';
  document.getElementById('currentPassword').value = '';
  document.getElementById('newPasswordProfile').value = '';
  document.getElementById('confirmNewPasswordProfile').value = '';
}

function changePassword() {
  if (!currentUser) {
    showAlert('يرجى تسجيل الدخول أولاً', 'error');
    return;
  }
  
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPasswordProfile').value;
  const confirmNewPassword = document.getElementById('confirmNewPasswordProfile').value;
  
  if (!currentPassword || !newPassword || !confirmNewPassword) {
    showAlert('يرجى ملء جميع الحقول', 'error');
    return;
  }
  
  if (newPassword !== confirmNewPassword) {
    showAlert('كلمات المرور غير متطابقة', 'error');
    return;
  }
  
  if (newPassword.length < 6) {
    showAlert('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
    return;
  }
  
  // التحقق من كلمة المرور الحالية
  if (currentPassword !== currentUser.password) {
    showAlert('كلمة المرور الحالية غير صحيحة', 'error');
    return;
  }
  
  // تحديث كلمة المرور
  const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
  const userIndex = users.findIndex(u => u.id === currentUser.id);
  
  if (userIndex > -1) {
    users[userIndex].password = newPassword;
    localStorage.setItem('mrStoreUsers', JSON.stringify(users));
    currentUser = users[userIndex];
    localStorage.setItem('mrStoreUser', JSON.stringify(currentUser));
    
    closeModal('changePasswordModal');
    showAlert('تم تغيير كلمة المرور بنجاح', 'success');
  }
}

// ================= أسئلة الأمان =================
function openSecuritySettings() {
  if (!currentUser) {
    showAlert('يرجى تسجيل الدخول أولاً', 'error');
    return;
  }
  
  // تحميل أسئلة الأمان الحالية
  document.getElementById('editSecurityQuestion1').value = currentUser.securityQuestions?.question1 || '';
  document.getElementById('editSecurityAnswer1').value = '';
  document.getElementById('editSecurityQuestion2').value = currentUser.securityQuestions?.question2 || '';
  document.getElementById('editSecurityAnswer2').value = '';
  
  // عرض معلومات أسئلة الأمان
  const securityInfo = document.getElementById('securityQuestionsInfo');
  securityInfo.innerHTML = `
    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
      <h4 style="color: var(--accent); margin-bottom: 10px;">أسئلة الأمان الحالية:</h4>
      <p>1. ${SECURITY_QUESTIONS[currentUser.securityQuestions?.question1] || 'غير محدد'}</p>
      <p>2. ${SECURITY_QUESTIONS[currentUser.securityQuestions?.question2] || 'غير محدد'}</p>
    </div>
  `;
  
  document.getElementById('securitySettingsModal').style.display = 'flex';
}

function updateSecurityQuestions() {
  if (!currentUser) {
    showAlert('يرجى تسجيل الدخول أولاً', 'error');
    return;
  }
  
  const question1 = document.getElementById('editSecurityQuestion1').value;
  const answer1 = document.getElementById('editSecurityAnswer1').value.trim().toLowerCase();
  const question2 = document.getElementById('editSecurityQuestion2').value;
  const answer2 = document.getElementById('editSecurityAnswer2').value.trim().toLowerCase();
  
  // إذا تم إدخال سؤال جديد، يجب إدخال الإجابة
  if ((question1 && !answer1) || (question2 && !answer2)) {
    showAlert('يرجى إدخال إجابة لكل سؤال تم اختياره', 'error');
    return;
  }
  
  // تحديث أسئلة الأمان
  const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
  const userIndex = users.findIndex(u => u.id === currentUser.id);
  
  if (userIndex > -1) {
    // الحفاظ على الأسئلة القديمة إذا لم يتم تغييرها
    users[userIndex].securityQuestions = {
      question1: question1 || currentUser.securityQuestions?.question1 || '',
      answer1: answer1 || currentUser.securityQuestions?.answer1 || '',
      question2: question2 || currentUser.securityQuestions?.question2 || '',
      answer2: answer2 || currentUser.securityQuestions?.answer2 || ''
    };
    
    localStorage.setItem('mrStoreUsers', JSON.stringify(users));
    currentUser = users[userIndex];
    localStorage.setItem('mrStoreUser', JSON.stringify(currentUser));
    
    closeModal('securitySettingsModal');
    showAlert('تم تحديث أسئلة الأمان بنجاح', 'success');
  }
}

// ================= التنقل بين الأقسام =================
function showSection(sectionId) {
  // إخفاء جميع الأقسام
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  
  // إزالة التحديد من جميع أزرار التنقل
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // إظهار القسم المطلوب
  document.getElementById(sectionId + 'Section').classList.add('active');
  
  // تحديد زر التنقل المناسب
  const navBtn = document.querySelector(`.nav-btn[onclick="showSection('${sectionId}')"]`);
  if (navBtn) {
    navBtn.classList.add('active');
  }
  
  // إذا كان قسم الملف الشخصي، تأكد من تسجيل الدخول
  if (sectionId === 'profile' && !currentUser) {
    openAuthModal();
    showSection('products');
    return;
  }
  
  // إذا كان قسم المنتجات، إعادة تعيين الاختيارات
  if (sectionId === 'products') {
    resetProductSelection();
  }
  
  // إذا كان قسم بطاقات الانترنت، إعادة تعيين الاختيارات
  if (sectionId === 'internet') {
    updateCardsSummary();
  }
}

// ================= إدارة بطاقات الانترنت =================
function selectOperator(operator) {
  currentOperator = operator;
  
  // تحديث التحديد المرئي
  document.querySelectorAll('.operator-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // تحميل البطاقات للشركة المختارة
  loadZainCards();
}

function selectInternetType(operator, type) {
  currentInternetType = type;
  
  // تحديث التحديد المرئي
  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (type === 'calls') {
    document.getElementById('zainCallsBtn').classList.add('active');
    document.getElementById('zainInternetBtn').classList.remove('active');
  } else if (type === 'internet') {
    document.getElementById('zainCallsBtn').classList.remove('active');
    document.getElementById('zainInternetBtn').classList.add('active');
  }
  
  // إظهار البطاقات المناسبة
  showInternetCards(operator, type);
}

function loadZainCards() {
  // إظهار بطاقات زين المكالمات أولاً
  showInternetCards('zain', 'calls');
}

function showInternetCards(operator, type) {
  const cardsContainer = operator === 'zain' ? 
    (type === 'calls' ? 'zainCallsCards' : 'zainInternetCards') : null;
  
  if (!cardsContainer) return;
  
  const container = document.getElementById(cardsContainer);
  container.innerHTML = '';
  
  const cards = operator === 'zain' ? DATA.zain[type] : [];
  
  cards.forEach(card => {
    const cardElement = document.createElement('div');
    cardElement.className = 'card-item';
    cardElement.setAttribute('data-category', 'internet');
    cardElement.setAttribute('data-company', operator);
    cardElement.setAttribute('data-product', `${operator}-${type}-${card.name}`);
    cardElement.setAttribute('data-price', card.price);
    cardElement.setAttribute('data-title', card.name);
    cardElement.setAttribute('data-description', card.desc);
    cardElement.onclick = () => selectCard(cardElement);
    
    cardElement.innerHTML = `
      <div class="card-header">
        <h4 class="card-title" style="color: ${operator === 'zain' ? '#ff0000' : '#0088cc'};">${card.name}</h4>
        <span class="card-price">${card.price.toFixed(2)} د.أ</span>
      </div>
      <div class="card-description">
        ${card.desc}
      </div>
      <ul class="card-features">
        <li>تفعيل فوري</li>
        <li>صلاحية 30 يوم</li>
        <li>دعم كافة الأجهزة</li>
        <li>أسعار منافسة</li>
      </ul>
    `;
    
    container.appendChild(cardElement);
  });
  
  // إخفاء/إظهار الحاويات المناسبة
  if (operator === 'zain') {
    if (type === 'calls') {
      document.getElementById('zainCallsCards').style.display = 'block';
      document.getElementById('zainInternetCards').style.display = 'none';
    } else {
      document.getElementById('zainCallsCards').style.display = 'none';
      document.getElementById('zainInternetCards').style.display = 'block';
    }
  }
}

// ================= إدارة TOP UP =================
function selectCategory(category) {
  selectedCategory = category;
  
  // تحديث التحديد المرئي
  document.querySelectorAll('.category-card').forEach(card => {
    card.classList.remove('active');
  });
  document.querySelector(`.category-card[data-category="${category}"]`).classList.add('active');
  
  // إظهار/إخفاء الأقسام
  if (category === 'games') {
    document.getElementById('gamesCategory').style.display = 'block';
    document.getElementById('psnCategory').style.display = 'none';
    document.getElementById('taxWarning').style.display = 'none';
    resetProductSelection();
  } else if (category === 'psn') {
    document.getElementById('gamesCategory').style.display = 'none';
    document.getElementById('psnCategory').style.display = 'block';
    document.getElementById('taxWarning').style.display = 'block';
    resetProductSelection();
  }
}

function selectGame() {
  const gameSelect = document.getElementById('gameSelect');
  selectedGame = gameSelect.value;
  
  // إظهار/إخفاء تنبيه الضريبة لـ Roblox
  if (selectedGame === 'roblox') {
    document.getElementById('taxWarning').style.display = 'block';
  } else {
    document.getElementById('taxWarning').style.display = 'none';
  }
  
  if (!selectedGame) {
    document.getElementById('gamePackages').style.display = 'none';
    return;
  }
  
  // عرض الباقات
  const packagesGrid = document.getElementById('gamePackages');
  packagesGrid.style.display = 'grid';
  packagesGrid.innerHTML = '';
  
  const packages = DATA.games[selectedGame];
  packages.forEach(pkg => {
    const packageCard = document.createElement('div');
    packageCard.className = 'package-card';
    packageCard.innerHTML = `
      <div class="package-name">${pkg.name}</div>
      <div class="package-price">${pkg.price.toFixed(2)} د.أ</div>
      <div class="package-desc">${pkg.desc}</div>
    `;
    packageCard.onclick = () => togglePackage(pkg);
    packagesGrid.appendChild(packageCard);
  });
  
  selectedPackages = [];
  updateOrderSummary();
}

function selectPSNRegion() {
  const regionSelect = document.getElementById('psnRegion');
  selectedPSNRegion = regionSelect.value;
  
  if (!selectedPSNRegion) {
    document.getElementById('psnPackages').style.display = 'none';
    return;
  }
  
  // عرض الباقات
  const packagesGrid = document.getElementById('psnPackages');
  packagesGrid.style.display = 'grid';
  packagesGrid.innerHTML = '';
  
  const packages = DATA.psn[selectedPSNRegion];
  packages.forEach(pkg => {
    const packageCard = document.createElement('div');
    packageCard.className = 'package-card';
    packageCard.innerHTML = `
      <div class="package-name">${pkg.name}</div>
      <div class="package-price">${pkg.price.toFixed(2)} د.أ</div>
      <div class="package-desc">${pkg.desc}</div>
    `;
    packageCard.onclick = () => togglePackage(pkg);
    packagesGrid.appendChild(packageCard);
  });
  
  selectedPackages = [];
  updateOrderSummary();
}

function togglePackage(package) {
  const index = selectedPackages.findIndex(p => p.name === package.name);
  
  if (index > -1) {
    // إزالة الباقة
    selectedPackages.splice(index, 1);
    
    // إزالة التحديد المرئي
    const packageCards = document.querySelectorAll('.package-card');
    packageCards.forEach(card => {
      if (card.querySelector('.package-name').textContent === package.name) {
        card.classList.remove('selected');
      }
    });
  } else {
    // إضافة الباقة (بحد أقصى 3)
    if (selectedPackages.length >= 3) {
      showAlert('يمكنك اختيار 3 باقات كحد أقصى', 'warning');
      return;
    }
    
    selectedPackages.push(package);
    
    // إضافة التحديد المرئي
    const packageCards = document.querySelectorAll('.package-card');
    packageCards.forEach(card => {
      if (card.querySelector('.package-name').textContent === package.name) {
        card.classList.add('selected');
      }
    });
  }
  
  updateOrderSummary();
}

function applyDiscount(type) {
  if (type === 'game') {
    if (gameDiscountApplied) {
      showAlert('الخصم مفعل مسبقاً', 'info');
      return;
    }
    
    if (selectedPackages.length === 0) {
      showAlert('يرجى اختيار باقات أولاً', 'warning');
      return;
    }
    
    gameDiscountApplied = true;
    document.getElementById('gameDiscountBtn').classList.add('used');
    updateOrderSummary();
    showAlert('تم تطبيق خصم 1.5% على الألعاب', 'success');
    
  } else if (type === 'psn') {
    if (psnDiscountApplied) {
      showAlert('الخصم مفعل مسبقاً', 'info');
      return;
    }
    
    if (selectedPackages.length === 0) {
      showAlert('يرجى اختيار باقات أولاً', 'warning');
      return;
    }
    
    psnDiscountApplied = true;
    document.getElementById('psnDiscountBtn').classList.add('used');
    updateOrderSummary();
    showAlert('تم تطبيق خصم 1.5% على PSN', 'success');
  }
}

function updateOrderSummary() {
  const selectedList = document.getElementById('selectedPackages');
  const totalElement = document.getElementById('productsTotal');
  
  if (selectedPackages.length === 0) {
    selectedList.innerHTML = '<li>لم يتم اختيار أي باقة</li>';
    totalElement.textContent = 'المجموع: 0.00 د.أ';
    totalPrice = 0;
    return;
  }
  
  // حساب السعر الإجمالي
  totalPrice = selectedPackages.reduce((sum, pkg) => sum + pkg.price, 0);
  
  // تطبيق الخصم
  if (selectedCategory === 'games' && gameDiscountApplied) {
    totalPrice = totalPrice * 0.985; // خصم 1.5%
  } else if (selectedCategory === 'psn' && psnDiscountApplied) {
    totalPrice = totalPrice * 0.985; // خصم 1.5%
  }
  
  // تحديث القائمة
  selectedList.innerHTML = '';
  selectedPackages.forEach(pkg => {
    const li = document.createElement('li');
    li.innerHTML = `
      <div>
        <div style="font-weight: bold; color: var(--accent);">${pkg.name}</div>
        <div style="font-size: 12px; color: var(--muted);">${pkg.desc}</div>
      </div>
      <div style="color: var(--gold); font-weight: bold;">${pkg.price.toFixed(2)} د.أ</div>
    `;
    selectedList.appendChild(li);
  });
  
  totalElement.textContent = `المجموع: ${totalPrice.toFixed(2)} د.أ`;
}

function resetProductSelection() {
  selectedGame = '';
  selectedPSNRegion = '';
  selectedPackages = [];
  gameDiscountApplied = false;
  psnDiscountApplied = false;
  
  document.getElementById('gameSelect').selectedIndex = 0;
  document.getElementById('psnRegion').selectedIndex = 0;
  document.getElementById('gamePackages').style.display = 'none';
  document.getElementById('psnPackages').style.display = 'none';
  document.getElementById('gameDiscountBtn').classList.remove('used');
  document.getElementById('psnDiscountBtn').classList.remove('used');
  document.getElementById('taxWarning').style.display = 'none';
  
  updateOrderSummary();
}

function clearOrder() {
  if (confirm('هل أنت متأكد من مسح الطلب بالكامل؟')) {
    resetProductSelection();
    document.getElementById('playerId').value = '';
    document.getElementById('instagram').value = '';
    document.getElementById('orderEmail').value = '';
    document.getElementById('orderNotes').value = '';
    showAlert('تم مسح الطلب بالكامل', 'success');
  }
}

function saveOrderDraft() {
  const draft = {
    category: selectedCategory,
    game: selectedGame,
    psnRegion: selectedPSNRegion,
    packages: selectedPackages,
    playerId: document.getElementById('playerId').value,
    instagram: document.getElementById('instagram').value,
    email: document.getElementById('orderEmail').value,
    notes: document.getElementById('orderNotes').value,
    gameDiscount: gameDiscountApplied,
    psnDiscount: psnDiscountApplied,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('orderDraft', JSON.stringify(draft));
  showAlert('تم حفظ الطلب كمسودة', 'success');
}

function submitOrder() {
  // التحقق من البيانات
  const playerId = document.getElementById('playerId').value.trim();
  const instagram = document.getElementById('instagram').value.trim();
  const email = document.getElementById('orderEmail').value.trim();
  
  if (!playerId || !instagram || !email) {
    showAlert('يرجى ملء جميع الحقول المطلوبة', 'error');
    return;
  }
  
  if (selectedPackages.length === 0) {
    showAlert('يرجى اختيار باقة واحدة على الأقل', 'error');
    return;
  }
  
  if (!validateEmail(email)) {
    showAlert('يرجى إدخال بريد إلكتروني صحيح', 'error');
    return;
  }
  
  // إنشاء تفاصيل الطلب
  const orderDetails = generateOrderDetails(playerId, instagram, email);
  
  // عرض Modal تأكيد الطلب
  document.getElementById('orderDetails').innerHTML = `
    <pre style="white-space: pre-wrap; color: white;">${orderDetails}</pre>
  `;
  document.getElementById('orderModal').style.display = 'flex';
  
  // حفظ الطلب للمستخدم (إذا كان مسجلاً)
  if (currentUser) {
    saveUserOrder(orderDetails, totalPrice);
  }
}

function generateOrderDetails(playerId, instagram, email) {
  let details = `🎮 **طلب جديد من MR Store**\n\n`;
  details += `📅 **التاريخ:** ${new Date().toLocaleString('ar-JO')}\n\n`;
  
  details += `👤 **معلومات العميل:**\n`;
  details += `🆔 **اللاعب:** ${playerId}\n`;
  details += `📱 **إنستغرام:** ${instagram}\n`;
  details += `📧 **البريد:** ${email}\n\n`;
  
  details += `🛒 **المنتجات المطلوبة:**\n`;
  if (selectedCategory === 'games') {
    details += `🎮 **اللعبة:** ${document.getElementById('gameSelect').selectedOptions[0].text}\n`;
    // إضافة تنبيه الضريبة إذا كانت Roblox
    if (selectedGame === 'roblox') {
      details += `⚠️ **تنبيه:** قد يتم تطبيق ضريبة إضافية بسبب الشركات المختصة بالبطاقات الخاصة بـ Roblox\n`;
    }
  } else if (selectedCategory === 'psn') {
    details += `🎴 **نوع PSN:** ${document.getElementById('psnRegion').selectedOptions[0].text}\n`;
    details += `📨 **طريقة الاستلام:** ${document.getElementById('psnDelivery').value}\n`;
    details += `⚠️ **تنبيه:** قد يتم تطبيق ضريبة إضافية بسبب الشركات المختصة بالبطاقات الخاصة بـ PlayStation\n`;
  }
  
  selectedPackages.forEach((pkg, index) => {
    details += `${index + 1}. ${pkg.name} - ${pkg.price.toFixed(2)} د.أ\n`;
  });
  
  // تطبيق الخصم إن وجد
  if ((selectedCategory === 'games' && gameDiscountApplied) || 
      (selectedCategory === 'psn' && psnDiscountApplied)) {
    const originalTotal = selectedPackages.reduce((sum, pkg) => sum + pkg.price, 0);
    details += `\n💰 **المجموع الأصلي:** ${originalTotal.toFixed(2)} د.أ`;
    details += `\n💰 **بعد الخصم (1.5%):** ${totalPrice.toFixed(2)} دينار أردني\n\n`;
  } else {
    details += `\n💰 **المجموع:** ${totalPrice.toFixed(2)} دينار أردني\n\n`;
  }
  
  const notes = document.getElementById('orderNotes').value.trim();
  if (notes) {
    details += `📝 **ملاحظات:**\n${notes}\n\n`;
  }
  
  details += `---\n`;
  details += `📞 **دعم العملاء:** mrsdforstore@gmail.com\n`;
  details += `💳 **طرق الدفع:** PayPal, U Wallet, Zain Cash, Orange Money\n`;
  
  return details;
}

function copyOrder() {
  const orderText = document.querySelector('#orderDetails pre').textContent;
  navigator.clipboard.writeText(orderText).then(() => {
    showAlert('تم نسخ تفاصيل الطلب', 'success');
  });
}

function openOrderEmail() {
  const orderText = document.querySelector('#orderDetails pre').textContent;
  const subject = encodeURIComponent('طلب جديد - MR Store');
  const body = encodeURIComponent(orderText);
  const mailtoLink = `mailto:mrsdforstore@gmail.com?subject=${subject}&body=${body}`;
  
  window.open(mailtoLink, '_blank');
  showAlert('جارٍ فتح تطبيق البريد الإلكتروني', 'info');
}

function saveUserOrder(orderDetails, total) {
  if (!currentUser) return;
  
  const users = JSON.parse(localStorage.getItem('mrStoreUsers') || '[]');
  const userIndex = users.findIndex(u => u.id === currentUser.id);
  
  if (userIndex > -1) {
    const order = {
      id: Date.now(),
      details: orderDetails,
      total: total,
      date: new Date().toISOString(),
      status: 'pending'
    };
    
    users[userIndex].orders = users[userIndex].orders || [];
    users[userIndex].orders.push(order);
    users[userIndex].totalSpent = (users[userIndex].totalSpent || 0) + total;
    
    localStorage.setItem('mrStoreUsers', JSON.stringify(users));
    currentUser = users[userIndex];
    localStorage.setItem('mrStoreUser', JSON.stringify(currentUser));
    
    updateProfileDisplay();
    updateOrderHistory();
  }
}

function updateOrderHistory() {
  const historyElement = document.getElementById('orderHistory');
  
  if (!currentUser || !currentUser.orders || currentUser.orders.length === 0) {
    historyElement.innerHTML = `
      <div class="order-card">
        <div class="order-date">لا توجد طلبات سابقة</div>
      </div>
    `;
    return;
  }
  
  historyElement.innerHTML = '';
  
  // ترتيب الطلبات من الأحدث إلى الأقدم
  const sortedOrders = [...currentUser.orders].sort((a, b) => new Date(b.date) - new Date(a.date));
  
  sortedOrders.forEach(order => {
    const orderCard = document.createElement('div');
    orderCard.className = 'order-card';
    
    // استخراج معلومات مختصرة من التفاصيل
    const lines = order.details.split('\n');
    const gameInfo = lines.find(line => line.includes('اللعبة:')) || lines.find(line => line.includes('نوع PSN:')) || 'طلب عام';
    const products = lines.filter(line => line.match(/^\d+\./)).slice(0, 2); // أول منتجين فقط
    
    orderCard.innerHTML = `
      <div class="order-date">${new Date(order.date).toLocaleString('ar-JO')}</div>
      <div class="order-items">${gameInfo.replace('🎮 **اللعبة:**', '').replace('🎴 **نوع PSN:**', '').trim()}</div>
      ${products.length > 0 ? `<div style="font-size: 14px; color: var(--muted); margin: 5px 0;">${products.join('<br>')}</div>` : ''}
      <div class="order-total">${order.total.toFixed(2)} د.أ</div>
      <div style="margin-top: 10px;">
        <button class="copy-btn" onclick="copyOrderText('${order.id}')" style="font-size: 12px; padding: 5px 10px;">
          <i class="fas fa-copy"></i>
          نسخ التفاصيل
        </button>
      </div>
    `;
    historyElement.appendChild(orderCard);
  });
}

function showOrderHistory() {
  showSection('profile');
}

// ================= إدارة بطاقات الانترنت =================
function selectCard(cardElement) {
  cardElement.classList.toggle('selected');
  
  const product = cardElement.getAttribute('data-product');
  const title = cardElement.getAttribute('data-title');
  const price = parseFloat(cardElement.getAttribute('data-price'));
  const description = cardElement.getAttribute('data-description');
  const company = cardElement.getAttribute('data-company');
  
  if (cardElement.classList.contains('selected')) {
    // إضافة البطاقة
    selectedCards.push({
      id: product,
      title: title,
      price: price,
      description: description,
      company: company
    });
  } else {
    // إزالة البطاقة
    const index = selectedCards.findIndex(card => card.id === product);
    if (index > -1) {
      selectedCards.splice(index, 1);
    }
  }
  
  updateCardsSummary();
}

function updateCardsSummary() {
  const selectedList = document.getElementById('selectedCards');
  const totalElement = document.getElementById('cardsTotal');
  
  if (selectedCards.length === 0) {
    selectedList.innerHTML = '<li>لم يتم اختيار أي بطاقة</li>';
    totalElement.textContent = 'المجموع: 0.00 د.أ';
    cardsTotalPrice = 0;
    return;
  }
  
  // حساب السعر الإجمالي
  cardsTotalPrice = selectedCards.reduce((sum, card) => sum + card.price, 0);
  
  // تحديث القائمة
  selectedList.innerHTML = '';
  selectedCards.forEach(card => {
    const li = document.createElement('li');
    li.innerHTML = `
      <div>
        <div style="font-weight: bold; color: var(--accent);">${card.title}</div>
        <div style="font-size: 12px; color: var(--muted);">${card.description}</div>
      </div>
      <div style="color: var(--gold); font-weight: bold;">${card.price.toFixed(2)} د.أ</div>
    `;
    selectedList.appendChild(li);
  });
  
  totalElement.textContent = `المجموع: ${cardsTotalPrice.toFixed(2)} د.أ`;
}

function clearCardsSelection() {
  if (confirm('هل أنت متأكد من مسح جميع البطاقات المختارة؟')) {
    document.querySelectorAll('.card-item').forEach(card => {
      card.classList.remove('selected');
    });
    
    selectedCards = [];
    cardsTotalPrice = 0;
    
    document.getElementById('cardsEmail').value = '';
    document.getElementById('cardsPhone').value = '';
    document.getElementById('cardsNotes').value = '';
    
    updateCardsSummary();
    showAlert('تم مسح جميع البطاقات', 'success');
  }
}

function submitCardsOrder() {
  const email = document.getElementById('cardsEmail').value.trim();
  const phone = document.getElementById('cardsPhone').value.trim();
  
  if (!email) {
    showAlert('يرجى إدخال البريد الإلكتروني', 'error');
    return;
  }
  
  if (!validateEmail(email)) {
    showAlert('يرجى إدخال بريد إلكتروني صحيح', 'error');
    return;
  }
  
  if (selectedCards.length === 0) {
    showAlert('يرجى اختيار بطاقة واحدة على الأقل', 'error');
    return;
  }
  
  // إنشاء تفاصيل الطلب
  const orderDetails = generateCardsOrderDetails(email, phone);
  
  // عرض Modal تأكيد الطلب
  document.getElementById('orderDetails').innerHTML = `
    <pre style="white-space: pre-wrap; color: white;">${orderDetails}</pre>
  `;
  document.getElementById('orderModal').style.display = 'flex';
  
  // حفظ الطلب للمستخدم (إذا كان مسجلاً)
  if (currentUser) {
    saveUserOrder(orderDetails, cardsTotalPrice);
  }
}

function generateCardsOrderDetails(email, phone) {
  let details = `🎴 **طلب بطاقات انترنت جديد من MR Store**\n\n`;
  details += `📅 **التاريخ:** ${new Date().toLocaleString('ar-JO')}\n\n`;
  
  details += `👤 **معلومات العميل:**\n`;
  details += `📧 **البريد:** ${email}\n`;
  if (phone) details += `📱 **الهاتف:** ${phone}\n`;
  details += `\n`;
  
  details += `🛒 **البطاقات المطلوبة:**\n`;
  selectedCards.forEach((card, index) => {
    details += `${index + 1}. ${card.title}\n`;
    details += `   📝 ${card.description}\n`;
    details += `   💰 ${card.price.toFixed(2)} د.أ\n\n`;
  });
  
  details += `💰 **المجموع:** ${cardsTotalPrice.toFixed(2)} دينار أردني\n\n`;
  
  const notes = document.getElementById('cardsNotes').value.trim();
  if (notes) {
    details += `📝 **ملاحظات:**\n${notes}\n\n`;
  }
  
  details += `---\n`;
  details += `📞 **دعم العملاء:** mrsdforstore@gmail.com\n`;
  details += `💳 **طرق الدفع:** PayPal, U Wallet, Zain Cash, Orange Money\n`;
  
  return details;
}

// ================= وظائف مساعدة =================
function showAlert(message, type = 'info') {
  // إزالة أي رسالة سابقة
  const existingAlert = document.querySelector('.alert');
  if (existingAlert) {
    existingAlert.remove();
  }
  
  // إنشاء الرسالة الجديدة
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(alertDiv);
  
  // إزالة الرسالة بعد 4 ثواني
  setTimeout(() => {
    alertDiv.style.animation = 'slideInRight 0.3s ease reverse';
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 300);
  }, 4000);
}

function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function validatePhone(phone) {
  const re = /^07[789]\d{7}$/;
  return re.test(phone);
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showAlert('تم النسخ إلى الحافظة', 'success');
  });
}

function copyOrderText(orderId) {
  if (!currentUser || !currentUser.orders) return;
  
  const order = currentUser.orders.find(o => o.id == orderId);
  if (order) {
    navigator.clipboard.writeText(order.details).then(() => {
      showAlert('تم نسخ تفاصيل الطلب', 'success');
    });
  }
}

function toggleUserDropdown() {
  const dropdown = document.getElementById('userDropdown');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

// إغلاق القوائم المنسدلة عند النقر خارجها
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('userDropdown');
  const avatar = document.getElementById('userAvatar');
  
  if (dropdown && dropdown.style.display === 'block' && 
      !dropdown.contains(event.target) && 
      !avatar.contains(event.target)) {
    dropdown.style.display = 'none';
  }
});

// عرض رسالة ترحيبية
window.onload = function() {
  setTimeout(() => {
    if (!currentUser) {
      showAlert('مرحباً بك في MR Store! يمكنك التسجيل لحفظ طلباتك', 'info');
    }
    
    // تحميل البريد الإلكتروني المحفوظ للتذكر
    const rememberedEmail = localStorage.getItem('mrStoreRemember');
    if (rememberedEmail) {
      document.getElementById('loginEmail').value = rememberedEmail;
      document.getElementById('rememberMe').checked = true;
    }
  }, 1000);
};
</script>
</body>
</html>
