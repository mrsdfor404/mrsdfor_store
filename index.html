<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MR Store</title>
<style>
:root{--bg:#0b0f1a;--card:#111726;--accent:#4da3ff;--gold:#ffd700;--note:#ffcc00;--muted:#99a3b3}
body{margin:0;font-family:"Tajawal",sans-serif;background:var(--bg);color:#fff}
header{background:var(--card);padding:18px;text-align:center;font-size:22px;color:var(--accent);font-weight:700;position:relative}
nav{background:#131a2c;display:flex;justify-content:center;gap:8px;padding:8px}
nav a{color:var(--accent);text-decoration:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
nav a:hover{background:#0f1724}
.container{max-width:820px;margin:22px auto;background:var(--card);padding:20px;border-radius:12px;border:1px solid #4da3ff33;box-sizing:border-box}

label{display:block;margin-top:12px;font-weight:700;text-align:right}

select,input,textarea{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:12px;
  border:none;
  background:#0f1724;
  color:#fff;
  box-sizing:border-box;
  outline:none;
  box-shadow:0 0 12px rgba(0,255,200,0.55);
  transition:0.25s;
}

select:focus,input:focus,textarea:focus{
  box-shadow:0 0 18px rgba(0,255,200,0.85);
}

select[multiple]{height:150px}

.row{display:flex;gap:12px;align-items:center}
.small{width:48%}

button{
  width:100%;
  padding:12px;
  background:var(--accent);
  color:#081220;
  border:none;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
  margin-top:12px;
  transition:0.2s;
}

button:hover{transform:scale(1.02)}

.discount-btn{
  background:#00d4aa;
  color:#000;
  font-weight:900;
  border-radius:10px;
  padding:10px;
}

.discount-btn.used{
  background:#444;
  color:#999;
  cursor:default;
}

.total{color:var(--gold);font-weight:900;margin-top:8px}

.note{
  background:#0e1724;
  padding:10px;
  border-radius:8px;
  color:var(--note);
  text-align:center;
  margin-top:12px
}

.footer{padding:16px;text-align:center;color:#bbb;margin-top:18px}

/* success popup */
.success-popup{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  z-index:9999;
  justify-content:center;
  align-items:center
}

.popup-card{
  background:var(--card);
  padding:22px;
  border-radius:14px;
  text-align:center;
  border:1px solid #4da3ff33;
  max-width:420px
}

.crown{
  font-size:56px;
  color:var(--gold);
  text-shadow:0 0 14px #ffec99;
  margin-bottom:6px
}

.popup-card h2{
  color:#00ffcc;
  margin:8px 0
}

/* small sign button top-right */
#authBtn{
  position:fixed;
  top:14px;
  right:14px;
  background:linear-gradient(180deg,#0ff3d0,#00b2ff);
  color:#051020;
  border-radius:10px;
  padding:8px 12px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,0.4);
  z-index:10000;
  border: none;
}
#authBtn:hover{transform:translateY(-2px);}

/* user menu when logged in */
#userMenu{
  position:fixed;
  top:14px;
  right:14px;
  display:flex;
  gap:8px;
  align-items:center;
  z-index:10000;
}
#userAvatar{
  width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#ffd700,#ffb84d);display:flex;align-items:center;justify-content:center;color:#081220;font-weight:900;cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,0.4);
  border:2px solid rgba(255,255,255,0.06);
}
#userNameLabel{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:var(--accent);font-weight:800;cursor:pointer}

/* dropdown menu */
#userDropdown{display:none;position:fixed;top:58px;right:14px;background:var(--card);border:1px solid #4da3ff33;padding:8px;border-radius:10px;min-width:160px;box-shadow:0 8px 30px rgba(0,0,0,0.6);z-index:10000}
#userDropdown button{width:100%;text-align:right;padding:8px;background:transparent;color:#fff;border:none;cursor:pointer;border-radius:8px}
#userDropdown button:hover{background:#0f1724}

/* auth modal */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(1,6,12,0.6);z-index:10001;justify-content:center;align-items:center}
.modal{background:var(--card);padding:18px;border-radius:12px;width:360px;max-width:92%;border:1px solid #4da3ff33}
.modal h3{margin:0 0 12px;color:#00ffcc}
.modal .row{flex-direction:column}
.form-row{margin-bottom:8px;text-align:right}
.small-note{font-size:13px;color:var(--muted);margin-top:6px}

/* profile page container (overlay) */
#profilePanel{display:none;position:fixed;inset:60px 20px 20px 20px;background:rgba(2,6,12,0.9);z-index:10002;padding:18px;border-radius:12px;overflow:auto;border:1px solid #4da3ff33}
.profile-header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.profile-box{background:var(--card);padding:12px;border-radius:10px;border:1px solid #4da3ff33;margin-top:12px}
.order-item{background:#0e1724;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03)}

/* rating stars */
.stars{display:inline-flex;gap:6px}
.star{font-size:20px;cursor:pointer;color:var(--muted)}
.star.active{color:var(--gold)}

/* responsive tweaks */
@media(max-width:520px){
  #userNameLabel{display:none}
  .modal{width:92%}
  #authBtn{padding:8px 10px;font-size:14px}
}
</style>
</head>
<body>

<header>MR Store</header>

<!-- auth button / user menu -->
<button id="authBtn" onclick="openAuth()">Sign in or sign up</button>

<div id="userMenu" style="display:none">
  <div id="userAvatar" onclick="toggleDropdown()">A</div>
  <div id="userNameLabel" onclick="toggleDropdown()">Ø§Ø³Ù…Ùƒ</div>
</div>
<div id="userDropdown">
  <button onclick="openProfile()">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<nav>
  <a onclick="showProducts()">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
  <a onclick="showPayment()">Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</a>
  <a onclick="showCards()">Ø¨Ø·Ø§Ù‚Ø§Øª</a>
</nav>

<!-- ===================== Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ ===================== -->
<div class="container" id="paymentSection" style="display:none">
  <h3 style="color:var(--gold);margin:0 0 8px">Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</h3>
  <p style="line-height:1.6">
    â€¢ U Wallet<br>
    â€¢ Zain Cash<br>
    â€¢ Orange Money<br>
    â€¢ Click
  </p>

  <p style="margin-top:8px">
    Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±:
    <b id="aliasName" style="color:var(--gold)">MRSDFOR</b>
  </p>

  <button type="button" onclick="copyAlias()">Ù†Ø³Ø® Ø§Ù„Ø§Ø³Ù…</button>

  <div class="note" style="margin-top:12px">
    Ø¯Ø¹Ù…: <b style="color:#fff">elzw520@gmail.com</b>
  </div>

  <div class="note" style="margin-top:14px;background:#162033;color:#ffd700;padding:14px">
    ÙÙŠ Ø­Ø§Ù„ Ø¯Ø¹Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø§Ø³Ù…ØŒ  
    ÙˆÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø¯Ø¹Ù…Ù‡ ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ£Ù† ÙŠÙƒÙˆÙ† Ù…ØªÙˆÙØ± Ù„Ù„ØªÙˆØ§ØµÙ„  
    Ø£Ùˆ Ø­Ø³Ø§Ø¨ Instagram. Ø´ÙƒØ±Ù‹Ø§ ğŸ¤ğŸ¤
  </div>
</div>

<!-- ===================== Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===================== -->
<div class="container" id="productsSection" style="display:none">
  <form id="orderForm" onsubmit="return false">

    <label for="category">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
    <select id="category" onchange="updateCategory()" required>
      <option value="">-- Ø§Ø®ØªØ± --</option>
      <option value="games">GAMES</option>
      <option value="psn">PSN CARDS</option>
    </select>

    <!-- Ø§GAMES -->
    <div id="gamesSection" style="display:none;margin-top:12px">
      <label for="game">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©:</label>
      <select id="game" onchange="updateGameOptions()">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨Ø© --</option>
        <option value="pubg">PUBG Mobile</option>
        <option value="freefire">Free Fire</option>
        <option value="deltaforce">Delta Force Mobile</option>
        <option value="roblox">Roblox (USA)</option>
        <option value="newstate">PUBG New State</option>
      </select>

      <div id="gameAmountSection" style="display:none;margin-top:8px">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Ø­ØªÙ‰ 3 Ø¨Ø§Ù‚Ø§Øª):</label>
        <select id="gameAmount" multiple onchange="handleSelectionLimit('game')"></select>

        <button type="button" id="gameDiscountBtn" class="discount-btn" onclick="applyDiscount('game')">
          ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… 1.5%
        </button>

        <div id="gameTotal" class="total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£</div>
      </div>
    </div>

    <!-- PSN -->
    <div id="psnSection" style="display:none;margin-top:12px">
      <label for="psnType">Ø§Ø®ØªØ± Ù†ÙˆØ¹ PSN:</label>
      <select id="psnType" onchange="updatePSNOptions()">
        <option value="">-- Ø§Ø®ØªØ± --</option>
        <option value="usa">PSN USA</option>
        <option value="sa">PSN SA</option>
      </select>

      <div id="psnAmountSection" style="display:none;margin-top:8px">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Ø­ØªÙ‰ 3 Ø¨Ø§Ù‚Ø§Øª):</label>
        <select id="psnAmount" multiple onchange="handleSelectionLimit('psn')"></select>

        <div class="row" style="margin-top:8px">
          <div class="small">
            <label>ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… PSN (1.5%)</label>
            <button type="button" id="psnDiscountBtn" class="discount-btn" onclick="applyDiscount('psn')">
              ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… 1.5%
            </button>
          </div>

          <div class="small">
            <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
            <select id="psnDelivery">
              <option value="direct">Ø´Ø­Ù† Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø­Ø³Ø§Ø¨</option>
              <option value="code">Ø§Ø³ØªÙ„Ø§Ù… ÙƒÙˆØ¯</option>
            </select>
          </div>
        </div>

        <div id="psnTotal" class="total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£</div>
      </div>
    </div>

    <!-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div id="detailsSection" style="display:none;margin-top:14px">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / ID:</label>
      <input id="username" placeholder="Ù…Ø«Ø§Ù„: player123" required>

      <label>Ø¥Ù†Ø³ØªØºØ±Ø§Ù…:</label>
      <input id="insta" placeholder="@username" required>

      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
      <input id="email" type="email" placeholder="example@mail.com" required>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
      <textarea id="notes" placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ø¨Ø± GMAIL ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªØ¶Ù Ø§Ù„insta"></textarea>

      <button type="button" id="sendBtn" onclick="sendOrder()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>

      <div class="note" style="margin-top:12px">
        Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <b>asdm86411@gmail.com</b>
      </div>
    </div>

  </form>
</div>

<!-- ===================== Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ===================== -->
<div class="container" id="cardsSection" style="display:none">
  <h3 style="color:#00ffcc;text-align:center;margin:0 0 12px">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h3>
  <p style="text-align:center;font-size:18px;color:#ffd700">
    Ø³ÙŠØªÙ… ØªÙˆÙÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù‚Ø±ÙŠØ¨Ø§Ù‹ â­
  </p>
</div>

<!-- profile panel -->
<div id="profilePanel">
  <div class="profile-header">
    <div style="display:flex;gap:12px;align-items:center">
      <div id="profileAvatar" style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#ffd700,#ffb84d);display:flex;align-items:center;justify-content:center;color:#081220;font-weight:900;font-size:22px">A</div>
      <div>
        <div id="profileName" style="font-size:20px;font-weight:900;color:var(--accent)">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
        <div id="profileInsta" style="color:var(--muted);font-size:14px">@insta</div>
      </div>
    </div>
    <div>
      <button onclick="closeProfile()" style="width:auto;padding:8px 12px;background:#4da3ff;color:#fff;border-radius:10px;border:none;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <div class="profile-box">
    <h4>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…" style="width:45%"/>
      <input id="editInsta" placeholder="@instagram" style="width:45%"/>
    </div>
    <button onclick="saveProfile()" style="margin-top:10px">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
  </div>

  <div class="profile-box">
    <h4>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
    <div id="ordersList">
      <p style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>
    </div>
  </div>

</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ -->
<div class="success-popup" id="successPopup">
  <div class="popup-card">
    <div class="crown">ğŸ‘‘</div>
    <h2>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„Ùƒ Ù…Ø¹ MR Store</h2>
    <p>ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø·Ù„Ø¨Ùƒ ÙˆÙØªØ­ Ø§Ù„Ø¨Ø±ÙŠØ¯.</p>
    <button onclick="closePopup()">ØªÙ…</button>
  </div>
</div>

<footer class="footer">Â© 2025 MR Store</footer>

<script>
/* ================= DATA ================= */
const DATA = {
  games:{
    pubg:[{name:"30 Ø´Ø¯Ø©",price:0.40},{name:"60 Ø´Ø¯Ø©",price:0.70},{name:"300+25 Ø´Ø¯Ø©",price:3.25},{name:"600+60 Ø´Ø¯Ø©",price:6.35},{name:"1500+300 Ø´Ø¯Ø©",price:15.70}],
    freefire:[{name:"110 Ø¬ÙˆØ§Ù‡Ø±",price:0.75},{name:"231 Ø¬ÙˆÙ‡Ø±Ø©",price:1.45},{name:"583 Ø¬ÙˆÙ‡Ø±Ø©",price:3.50},{name:"1188 Ø¬ÙˆÙ‡Ø±Ø©",price:6.90},{name:"2420 Ø¬ÙˆÙ‡Ø±Ø©",price:13.80}],
    deltaforce:[{name:"19 Ø°Ù‡Ø¨Ø©",price:0.30},{name:"32 Ø°Ù‡Ø¨Ø©",price:0.45},{name:"63 Ø°Ù‡Ø¨Ø©",price:0.80},{name:"336 Ø°Ù‡Ø¨Ø©",price:4.00},{name:"482 Ø°Ù‡Ø¨Ø©",price:5.50},{name:"785 Ø°Ù‡Ø¨Ø©",price:7.40}],
    roblox:[{name:"$10",price:7.60},{name:"$20",price:14.60},{name:"$25",price:18.00},{name:"$40",price:28.60},{name:"$50",price:35.65},{name:"$100",price:71.00}],
    newstate:[{name:"300 NC",price:1.00},{name:"1500+80 NC",price:3.80},{name:"3600+250 NC",price:8.90},{name:"9300+930 NC",price:22.50}]
  },
  psn:{
    usa:[{name:"$10",price:7.20},{name:"$25",price:17.85},{name:"$50",price:32.80},{name:"$55",price:39.50},{name:"$75",price:53.50}],
    sa:[{name:"$10",price:8.25},{name:"$20",price:15.20},{name:"$40",price:30.40},{name:"$50",price:37.75},{name:"$70",price:52.35}]
  }
};

/* ELEMENTS */
const paymentSection=document.getElementById('paymentSection');
const productsSection=document.getElementById('productsSection');
const gamesSection=document.getElementById('gamesSection');
const psnSection=document.getElementById('psnSection');
const cardsSection=document.getElementById('cardsSection');
const gameAmount=document.getElementById('gameAmount');
const psnAmount=document.getElementById('psnAmount');
const gameTotalEl=document.getElementById('gameTotal');
const psnTotalEl=document.getElementById('psnTotal');
const detailsSection=document.getElementById('detailsSection');
const gameDiscountBtn=document.getElementById('gameDiscountBtn');
const psnDiscountBtn=document.getElementById('psnDiscountBtn');

const authBtn=document.getElementById('authBtn');
const userMenu=document.getElementById('userMenu');
const userAvatar=document.getElementById('userAvatar');
const userNameLabel=document.getElementById('userNameLabel');
const userDropdown=document.getElementById('userDropdown');
const cardsSectionEl=document.getElementById('cardsSection');
const profilePanel=document.getElementById('profilePanel');
const profileAvatar=document.getElementById('profileAvatar');
const profileNameLabel=document.getElementById('profileName');
const profileInstaLabel=document.getElementById('profileInsta');
const ordersList=document.getElementById('ordersList');

let currentUser = null; // object {username, insta, email, password, orders: [{body, date, total, rating}], createdAt}

/* SHOW SECTIONS */
function showPayment(){productSectionHidden();paymentSection.style.display='block';cardsSectionEl.style.display='none';window.scrollTo({top:0,behavior:'smooth'});}
function showProducts(){paymentSection.style.display='none';productsSection.style.display='block';cardsSectionEl.style.display='none';window.scrollTo({top:0,behavior:'smooth'});}
function showCards(){productSectionHidden();paymentSection.style.display='none';cardsSectionEl.style.display='block';window.scrollTo({top:0, behavior:'smooth'});}
function productSectionHidden(){productsSection.style.display='none';}

/* CATEGORY */
function updateCategory(){
  const c=document.getElementById('category').value;
  gamesSection.style.display=(c==='games')?'block':'none';
  psnSection.style.display=(c==='psn')?'block':'none';
  detailsSection.style.display='none';
  gameAmount.innerHTML='';
  psnAmount.innerHTML='';
  gameTotalEl.textContent='Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£';
  psnTotalEl.textContent='Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£';
  resetDiscountButton('game');
  resetDiscountButton('psn');
}

/* GAMES LIST */
function updateGameOptions(){
  const g=document.getElementById('game').value;
  gameAmount.innerHTML='';
  if(!g){document.getElementById('gameAmountSection').style.display='none';return;}
  DATA.games[g].forEach(item=>{
    const o=document.createElement('option');
    o.value=`${item.name} - ${item.price.toFixed(2)}`;
    o.dataset.basePrice=item.price;
    o.dataset.price=item.price;
    o.textContent=`${item.name} - ${item.price.toFixed(2)} Ø¯.Ø£`;
    gameAmount.appendChild(o);
  });
  document.getElementById('gameAmountSection').style.display='block';
  calculateTotal('game');
}

/* PSN LIST */
function updatePSNOptions(){
  const p=document.getElementById('psnType').value;
  psnAmount.innerHTML='';
  if(!p){document.getElementById('psnAmountSection').style.display='none';return;}
  DATA.psn[p].forEach(item=>{
    const o=document.createElement('option');
    o.value=`${item.name} - ${item.price.toFixed(2)}`;
    o.dataset.basePrice=item.price;
    o.dataset.price=item.price;
    o.textContent=`${item.name} - ${item.price.toFixed(2)} Ø¯.Ø£`;
    psnAmount.appendChild(o);
  });
  document.getElementById('psnAmountSection').style.display='block';
  calculateTotal('psn');
}

/* LIMIT SELECT */
function handleSelectionLimit(section){
  const el=(section==='game')?gameAmount:psnAmount;
  const selected=[...el.selectedOptions];
  if(selected.length>3){
    alert('Ù…Ø³Ù…ÙˆØ­ Ø§Ø®ØªÙŠØ§Ø± 3 Ø¨Ø§Ù‚Ø§Øª ÙÙ‚Ø·');
    selected[selected.length-1].selected=false;
    return;
  }
  detailsSection.style.display=(selected.length>0)?'block':'none';
  calculateTotal(section);
}

/* TOTAL */
function calculateTotal(section){
  let total=0;
  if(section==='game'){
    [...gameAmount.selectedOptions].forEach(o=>{total+=parseFloat(o.dataset.price||0);});
    gameTotalEl.textContent=`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Ø¯.Ø£`;
  }else{
    [...psnAmount.selectedOptions].forEach(o=>{total+=parseFloat(o.dataset.price||0);});
    psnTotalEl.textContent=`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Ø¯.Ø£`;
  }
}

/* RESET DISCOUNT */
function resetDiscountButton(type){
  const btn=(type==='game')?gameDiscountBtn:psnDiscountBtn;
  const key=(type==='game')?'discount_used_games':'discount_used_psn';
  const last=localStorage.getItem(key);
  if(last && (Date.now()-parseInt(last))<7200000){
    btn.classList.add('used');
    btn.disabled=true;
    btn.textContent='âœ” ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®ØµÙ…';
  }else{
    btn.classList.remove('used');
    btn.disabled=false;
    btn.textContent='ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… 1.5%';
  }
}

/* APPLY DISCOUNT */
function applyDiscount(type){
  const key=(type==='game')?'discount_used_games':'discount_used_psn';
  const btn=(type==='game')?gameDiscountBtn:psnDiscountBtn;
  const last=localStorage.getItem(key);
  const now=Date.now();

  if(last && (now-parseInt(last))<7200000){
    const remaining=Math.ceil((7200000-(now-parseInt(last)))/60000);
    alert(`Ø§Ù„Ø®ØµÙ… Ù…Ø±Ø© ÙƒÙ„ Ø³Ø§Ø¹ØªÙŠÙ†. ØªØ¨Ù‚Ù‰ ${remaining} Ø¯Ù‚ÙŠÙ‚Ø©`);
    return;
  }

  const el=(type==='game')?gameAmount:psnAmount;
  [...el.options].forEach(op=>{
    const base=parseFloat(op.dataset.basePrice);
    const discounted=parseFloat((base*0.985).toFixed(2));
    op.dataset.price=discounted;
    const name=op.value.split('-')[0].trim();
    op.textContent=`${name} - ${discounted.toFixed(2)} Ø¯.Ø£`;
    op.value=`${name} - ${discounted.toFixed(2)}`;
  });

  localStorage.setItem(key,now);
  btn.classList.add('used');
  btn.disabled=true;
  btn.textContent='âœ” ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®ØµÙ…';
  calculateTotal(type);
}

/* ORDER BODY */
function buildOrderBodyEncoded(){
  const cat=document.getElementById('category').value||'-';
  const arr=[];
  arr.push("Ø§Ù„Ù…ØªØ¬Ø±: MR Store");
  arr.push(`Ø§Ù„Ù‚Ø³Ù…: ${cat}`);

  if(cat==='games'){
    const game=document.getElementById('game').value||'-';
    const selected=[...gameAmount.selectedOptions].map(o=>o.textContent);
    arr.push(`Ø§Ù„Ù„Ø¹Ø¨Ø©: ${game}`);
    arr.push(`Ø§Ù„Ø¨Ø§Ù‚Ø§Øª: ${selected.join(', ')||'-'}`);
  }

  if(cat==='psn'){
    const type=document.getElementById('psnType').value||'-';
    const selected=[...psnAmount.selectedOptions].map(o=>o.textContent);
    arr.push(`Ù†ÙˆØ¹ PSN: ${type}`);
    arr.push(`Ø§Ù„Ø¨Ø§Ù‚Ø§Øª: ${selected.join(', ')||'-'}`);
  }

  const totalGame=[...gameAmount.selectedOptions].reduce((s,o)=>s+parseFloat(o.dataset.price||0),0);
  const totalPsn=[...psnAmount.selectedOptions].reduce((s,o)=>s+parseFloat(o.dataset.price||0),0);
  const grand=(totalGame+totalPsn).toFixed(2);

  arr.push(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${grand} Ø¯.Ø£`);
  arr.push(`Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/ID: ${document.getElementById('username').value}`);
  arr.push(`Ø¥Ù†Ø³ØªØºØ±Ø§Ù…: ${document.getElementById('insta').value}`);
  arr.push(`Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${document.getElementById('email').value}`);
  arr.push(`Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${document.getElementById('notes').value||'-'}`);

  return encodeURIComponent(arr.join("\n"));
}

/* SEND ORDER */
async function sendOrder(){
  const cat=document.getElementById('category').value;
  if(!cat){alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…');return;}

  if(cat==='games' && gameAmount.selectedOptions.length===0){alert('Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');return;}
  if(cat==='psn' && psnAmount.selectedOptions.length===0){alert('Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');return;}

  const username=document.getElementById('username').value.trim();
  const insta=document.getElementById('insta').value.trim();
  const email=document.getElementById('email').value.trim();

  if(!username || !insta || !email){alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª");return;}

  const bodyEnc=buildOrderBodyEncoded();
  const bodyPlain=decodeURIComponent(bodyEnc);

  // copy order body to clipboard (legacy behavior)
  try{await navigator.clipboard.writeText(bodyPlain);}catch(e){}

  const subject=encodeURIComponent("Ø·Ù„Ø¨ Ù…Ù† MR Store");
  const to="asdm86411@gmail.com";
  const cc="elzw520@gmail.com";

  const link=`mailto:${to}?cc=${cc}&subject=${subject}&body=${bodyEnc}`;
  window.open(link,"_blank");

  // save order to logged-in user if exists
  saveOrderForUser(bodyPlain);

  document.getElementById('successPopup').style.display='flex';
  document.getElementById('orderForm').reset();

  gameAmount.innerHTML='';
  psnAmount.innerHTML='';
  gameTotalEl.textContent='Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£';
  psnTotalEl.textContent='Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£';
  detailsSection.style.display='none';
  gamesSection.style.display='none';
  psnSection.style.display='none';

  resetDiscountButton('game');
  resetDiscountButton('psn');
}

/* UTILITIES */
function copyAlias(){
  const alias=document.getElementById('aliasName').textContent.trim();
  navigator.clipboard.writeText(alias).then(()=>alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø§Ø³Ù…")).catch(()=>alert("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®"));
}

function closePopup(){
  document.getElementById('successPopup').style.display='none';
}

/* ========== Authentication (client-side) ========== */
/* storage structure:
 localStorage.mr_users = JSON.stringify({ username1: {username, insta, email, password, orders: [] }, ... })
 localStorage.mr_current = username
*/

function getUsers(){
  try{ return JSON.parse(localStorage.getItem('mr_users')||'{}'); } catch(e){ return {}; }
}
function saveUsers(obj){ localStorage.setItem('mr_users', JSON.stringify(obj)); }

function openAuth(){
  if(currentUser){ // already logged
    toggleDropdown();
    return;
  }
  // build modal
  const backdrop = document.createElement('div');
  backdrop.className='modal-backdrop';
  backdrop.id='authBackdrop';
  const modal = document.createElement('div');
  modal.className='modal';
  modal.innerHTML = `
    <h3>ØªØ³Ø¬ÙŠÙ„ / ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <div id="authForms">
      <div id="signInForm">
        <div class="form-row"><input id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" /></div>
        <div class="form-row"><input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" /></div>
        <div style="display:flex;gap:8px">
          <button onclick="doLogin()" style="flex:1">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <button onclick="showSignUp()" style="flex:1;background:#ffd700">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨</button>
        </div>
        <div class="small-note">Ø³ØªØ¨Ù‚Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</div>
      </div>
      <div id="signUpForm" style="display:none">
        <div class="form-row"><input id="regUser" placeholder="Ø§Ù„Ø§Ø³Ù…" /></div>
        <div class="form-row"><input id="regInsta" placeholder="@Instagram (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" /></div>
        <div class="form-row"><input id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" /></div>
        <div class="form-row"><input id="regPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" /></div>
        <div style="display:flex;gap:8px">
          <button onclick="doSignUp()" style="flex:1">ØªØ³Ø¬ÙŠÙ„</button>
          <button onclick="showSignIn()" style="flex:1;background:#ffd700">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
        <div class="small-note">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (ØºÙŠØ± Ù…Ø´ÙØ±Ø© Ù‡Ù†Ø§). Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¨Ø³Ù‘Ø· ÙÙ‚Ø·.</div>
      </div>
    </div>
    <div style="text-align:left;margin-top:8px"><button onclick="closeAuth()" style="background:transparent;color:var(--accent);border:none;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button></div>
  `;
  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);
  backdrop.style.display='flex';
  // simple close on backdrop click
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeAuth(); });
}

function closeAuth(){
  const b=document.getElementById('authBackdrop');
  if(b) b.remove();
}
function showSignUp(){
  document.getElementById('signInForm').style.display='none';
  document.getElementById('signUpForm').style.display='block';
}
function showSignIn(){
  document.getElementById('signInForm').style.display='block';
  document.getElementById('signUpForm').style.display='none';
}

// sign up
function doSignUp(){
  const name=document.getElementById('regUser').value.trim();
  const insta=document.getElementById('regInsta').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPass').value;

  if(!name||!email||!pass){ alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }

  const users=getUsers();
  if(users[email]){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹. Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.'); return; }

  users[email] = { username: name, insta: insta||'-', email, password: pass, orders: [], createdAt: Date.now() };
  saveUsers(users);
  localStorage.setItem('mr_current', email);
  setCurrentUser(users[email]);
  closeAuth();
  alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
}

// login
function doLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!email||!pass){ alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
  const users=getUsers();
  if(!users[email] || users[email].password !== pass){ alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©'); return; }
  localStorage.setItem('mr_current', email);
  setCurrentUser(users[email]);
  closeAuth();
  alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
}

function setCurrentUser(userObj){
  currentUser = userObj;
  // update UI
  authBtn.style.display='none';
  userMenu.style.display='flex';
  userAvatar.textContent = (userObj.username||'U').trim().slice(0,1).toUpperCase();
  userNameLabel.textContent = userObj.username;
  // update profile panel labels
  profileAvatar.textContent = userAvatar.textContent;
  profileNameLabel.textContent = userObj.username;
  profileInstaLabel.textContent = userObj.insta || '-';
}

// logout
function logout(){
  localStorage.removeItem('mr_current');
  currentUser = null;
  authBtn.style.display='inline-block';
  userMenu.style.display='none';
  userDropdown.style.display='none';
  alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
}

/* dropdown toggles */
function toggleDropdown(){
  userDropdown.style.display = (userDropdown.style.display === 'block') ? 'none' : 'block';
}

/* profile panel */
function openProfile(){
  userDropdown.style.display='none';
  buildProfilePanel();
  profilePanel.style.display='block';
}
function closeProfile(){ profilePanel.style.display='none'; }

function buildProfilePanel(){
  const users=getUsers();
  const key = localStorage.getItem('mr_current');
  if(!key || !users[key]){ alert('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
  const me = users[key];
  profileAvatar.textContent = (me.username||'U').slice(0,1).toUpperCase();
  profileNameLabel.textContent = me.username;
  profileInstaLabel.textContent = me.insta || '-';
  document.getElementById('editName').value = me.username;
  document.getElementById('editInsta').value = me.insta || '';
  // orders
  ordersList.innerHTML = '';
  if(!me.orders || me.orders.length===0){
    ordersList.innerHTML = '<p style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>';
  } else {
    me.orders.slice().reverse().forEach((ord, idx)=>{
      const div=document.createElement('div');
      div.className='order-item';
      div.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px"><div style="font-weight:800">${ord.date}</div><div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <b>${ord.total} Ø¯.Ø£</b></div></div>
      <pre style="white-space:pre-wrap;margin-top:8px;color:#fff;background:transparent;border:none">${ord.body}</pre>
      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <div>Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø®Ø¯Ù…Ø©:</div>
        <div class="stars" data-order="${idx}">
          ${renderStars(ord.rating || 0)}
        </div>
      </div>`;
      ordersList.appendChild(div);
    });
    // attach star clicks
    document.querySelectorAll('.stars').forEach(st => {
      st.querySelectorAll('.star').forEach(s => {
        s.addEventListener('click', (e)=>{
          const parent = e.target.parentElement;
          const orderIndex = parseInt(parent.getAttribute('data-order'),10);
          const rating = parseInt(e.target.getAttribute('data-val'),10);
          saveRatingForOrder(orderIndex, rating);
          buildProfilePanel(); // refresh
        });
      });
    });
  }
}

function renderStars(current){
  let out='';
  for(let i=1;i<=5;i++){
    out += `<span class="star ${i<=current?'active':''}" data-val="${i}">&#9733;</span>`;
  }
  return out;
}

function saveProfile(){
  const name = document.getElementById('editName').value.trim();
  const insta = document.getElementById('editInsta').value.trim();
  if(!name){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…'); return; }
  const users=getUsers();
  const key = localStorage.getItem('mr_current');
  if(!key || !users[key]){ alert('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
  users[key].username = name;
  users[key].insta = insta || '-';
  saveUsers(users);
  setCurrentUser(users[key]); // refresh UI
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù');
  buildProfilePanel();
}

/* orders storage */
function saveOrderForUser(bodyPlain){
  try{
    const users=getUsers();
    const key = localStorage.getItem('mr_current');
    if(!key || !users[key]) return; // not logged in -> do nothing
    // compute total from bodyPlain (we placed a line with "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: X Ø¯.Ø£")
    let total = 0;
    const match = bodyPlain.match(/Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:\s*([\d\.]+)\s*Ø¯/);
    if(match) total = parseFloat(match[1]) || 0;
    const entry = { body: bodyPlain, date: new Date().toLocaleString(), total, rating: 0 };
    users[key].orders = users[key].orders || [];
    users[key].orders.push(entry);
    // keep latest 30 orders max
    if(users[key].orders.length>30) users[key].orders.shift();
    saveUsers(users);
    // update current object
    currentUser = users[key];
  }catch(e){}
}

function saveRatingForOrder(idxFromLatest, rating){
  // idxFromLatest is index in reversed array used in display; convert to real index
  const users=getUsers();
  const key = localStorage.getItem('mr_current');
  if(!key || !users[key]){ alert('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
  const arr = users[key].orders || [];
  const realIndex = arr.length - 1 - idxFromLatest;
  if(arr[realIndex]){
    arr[realIndex].rating = rating;
    saveUsers(users);
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
  }
}

/* initialize UI from stored current user */
(function initAuthUI(){
  const key = localStorage.getItem('mr_current');
  const users=getUsers();
  if(key && users[key]){
    setCurrentUser(users[key]);
  } else {
    authBtn.style.display='inline-block';
    userMenu.style.display='none';
  }
})();

/* small utility to close dropdown when clicking outside */
document.addEventListener('click', (e)=>{
  if(!userMenu.contains(e.target) && !userDropdown.contains(e.target) && e.target!==userAvatar && e.target!==userNameLabel){
    userDropdown.style.display='none';
  }
});

/* show default products on load */
showProducts();
resetDiscountButton('game');
resetDiscountButton('psn');
</script>

</body>
</html>
